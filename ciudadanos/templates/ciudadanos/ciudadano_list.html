{% extends "includes/main.html" %}
{% load static %}

{% block title %}Historia Social Digital{% endblock %}
{% block titulo-pagina %}Historia Social Digital{% endblock %}

{% block content %}
    <!-- Estilos modernos reutilizables para listados -->
    <link rel="stylesheet" href="{% static 'custom/css/listModerno.css' %}" />
    {% with titulo_search='Buscar ciudadano' placeholder_text='Apellido, nombre o documento' help_text='Ingres√° apellido, nombre o DNI' reset_url_name='ciudadanos' %}
        {% include 'components/search_bar.html' with titulo=titulo_search placeholder=placeholder_text help_text=help_text reset_url=reset_url_name query=filter_form.q.value show_add_button=True add_url='ciudadanos_crear' add_text='Nuevo ciudadano' %}
    {% endwith %}
    <input type="hidden"
           name="q"
           id="hidden-q-input"
           form="simple-search-form"
           value="{{ filter_form.q.value|default:'' }}" />
    <div class="row mt-5 max-width-100">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">Listado de ciudadanos</h3>
                </div>
                <div class="card-body">
                    <form method="get"
                          class="row g-3 align-items-end mb-4"
                          id="province-filter-form">
                        <div class="col-12 col-md-8">
                            {{ filter_form.provincia.label_tag }}
                            {{ filter_form.provincia }}
                        </div>
                        <input type="hidden"
                               name="q"
                               id="province-hidden-q"
                               value="{{ filter_form.q.value|default:'' }}" />
                        <div class="col-12 col-md-4">
                            <button type="submit" class="btn btn-outline-secondary w-100">Aplicar</button>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped projects mb-0">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="apellido">
                                        Apellido
                                        <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="nombre">
                                        Nombre
                                        <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="documento">
                                        Documento
                                        <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="sexo">
                                        Sexo
                                        <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-column="provincia">
                                        Provincia
                                        <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th style="width: 15%" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ciudadanos-table-body">
                                {% for ciudadano in object_list %}
                                    <tr>
                                        <td data-apellido="{{ ciudadano.apellido }}">{{ ciudadano.apellido }}</td>
                                        <td data-nombre="{{ ciudadano.nombre }}">{{ ciudadano.nombre }}</td>
                                        <td data-documento="{{ ciudadano.documento|default:'' }}">{{ ciudadano.documento|default:"-" }}</td>
                                        <td data-sexo="{{ ciudadano.sexo|default:'' }}">{{ ciudadano.sexo|default:"-" }}</td>
                                        <td data-provincia="{{ ciudadano.provincia|default:'' }}">{{ ciudadano.provincia|default:"-" }}</td>
                                        <td class="text-center">
                                            <a href="{% url 'ciudadanos_ver' ciudadano.pk %}"
                                               class="btn btn-primary"
                                               title="Ver detalle del ciudadano">
                                                <i class="fas fa-eye"></i>
                                                Ver
                                            </a>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">No se encontraron ciudadanos.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-container" class="mt-3">
                        {% if is_paginated %}
                            {% include 'components/pagination.html' %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block customJS %}
    <!-- Script de ordenamiento reutilizable para tablas -->
    <script src="{% static 'custom/js/listSort.js' %}"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const searchInput = document.getElementById("ajax-search-input");
            const hiddenQInput = document.getElementById("hidden-q-input");
            const provinceHiddenQ = document.getElementById("province-hidden-q");
            const searchForm = document.getElementById("simple-search-form");
            const provinceForm = document.getElementById("province-filter-form");

            function syncHiddenFields() {
                if (searchInput) {
                    const value = searchInput.value || "";
                    if (hiddenQInput) hiddenQInput.value = value;
                    if (provinceHiddenQ) provinceHiddenQ.value = value;
                }
            }

            if (searchForm) {
                searchForm.addEventListener("submit", syncHiddenFields);
            }

            if (provinceForm) {
                provinceForm.addEventListener("submit", function () {
                    syncHiddenFields();
                });
            }

            // Inicializar valores al cargar
            syncHiddenFields();
        });
    </script>
{% endblock %}
