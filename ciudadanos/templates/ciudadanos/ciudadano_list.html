{% extends "includes/main.html" %}

{% block title %}Ciudadanos{% endblock %}
{% block titulo-pagina %}Ciudadanos{% endblock %}

{% block content %}
    {% with titulo_search='Buscar ciudadano' placeholder_text='Apellido, nombre o documento' help_text='Ingres√° apellido, nombre o DNI' reset_url_name='ciudadanos' %}
        {% include 'components/search_bar.html' with titulo=titulo_search placeholder=placeholder_text help_text=help_text reset_url=reset_url_name query=filter_form.q.value show_add_button=True add_url='ciudadanos_crear' add_text='Nuevo ciudadano' %}
    {% endwith %}
    <input type="hidden"
           name="q"
           id="hidden-q-input"
           form="simple-search-form"
           value="{{ filter_form.q.value|default:'' }}">
    <div class="row mt-5 max-width-100">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">Listado de ciudadanos</h3>
                </div>
                <div class="card-body">
                    <form method="get"
                          class="row g-3 align-items-end mb-4"
                          id="province-filter-form">
                        <div class="col-12 col-md-8">
                            {{ filter_form.provincia.label_tag }}
                            {{ filter_form.provincia }}
                        </div>
                        <input type="hidden"
                               name="q"
                               id="province-hidden-q"
                               value="{{ filter_form.q.value|default:'' }}">
                        <div class="col-12 col-md-4">
                            <button type="submit" class="btn btn-outline-secondary w-100">Aplicar</button>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped projects mb-0">
                            <thead>
                                <tr>
                                    <th>Apellido</th>
                                    <th>Nombre</th>
                                    <th>Documento</th>
                                    <th>Sexo</th>
                                    <th>Provincia</th>
                                    <th style="width: 15%" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ciudadanos-table-body">
                                {% for ciudadano in object_list %}
                                    <tr>
                                        <td>{{ ciudadano.apellido }}</td>
                                        <td>{{ ciudadano.nombre }}</td>
                                        <td>{{ ciudadano.documento|default:"-" }}</td>
                                        <td>{{ ciudadano.sexo|default:"-" }}</td>
                                        <td>{{ ciudadano.provincia|default:"-" }}</td>
                                        <td class="text-center">
                                            <a href="{% url 'ciudadanos_ver' ciudadano.pk %}"
                                               class="btn btn-primary btn-sm">Ver detalle</a>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">No se encontraron ciudadanos.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="pagination-container" class="mt-3">
                        {% if is_paginated %}
                            {% include 'components/pagination.html' %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block customJS %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const searchInput = document.getElementById("ajax-search-input");
            const hiddenQInput = document.getElementById("hidden-q-input");
            const provinceHiddenQ = document.getElementById("province-hidden-q");
            const searchForm = document.getElementById("simple-search-form");
            const provinceForm = document.getElementById("province-filter-form");

            function syncHiddenFields() {
                if (searchInput) {
                    const value = searchInput.value || "";
                    if (hiddenQInput) hiddenQInput.value = value;
                    if (provinceHiddenQ) provinceHiddenQ.value = value;
                }
            }

            if (searchForm) {
                searchForm.addEventListener("submit", syncHiddenFields);
            }

            if (provinceForm) {
                provinceForm.addEventListener("submit", function () {
                    syncHiddenFields();
                });
            }

            // Inicializar valores al cargar
            syncHiddenFields();
        });
    </script>
{% endblock %}
