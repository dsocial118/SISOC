{% extends "includes/main.html" %}
{% load static crispy_forms_tags custom_filters %}

{% block title %}Informe Técnico: {{ comedor.nombre }}{% endblock %}

{% block titulo-pagina %}Informe Técnico: {{ comedor.nombre }} - Estado: {{ informe_tecnico.estado }}{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <div class="breadcrumb-item">
            <a href="{% url 'admisiones_tecnicos_editar' admision.id %}">{{ admision.comedor.nombre }}</a>
        </div>
        <div class="breadcrumb-item active">Informe Técnico</div>
    </ol>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Errores -->
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}<p class="mb-0">{{ error }}</p>{% endfor %}
                </div>
            {% endif %}

            <!-- Campos a subsanar -->
            {% if campos_a_subsanar %}
                <div class="alert alert-danger">
                    <h5>Campos para subsanar</h5>
                </div>
            {% endif %}

            <!-- Observaciones -->
            {% if observacion %}
                <div class="alert alert-info">
                    <h6>Observaciones:</h6>
                    {{ observacion.texto }}
                </div>
            {% endif %}

            <!-- Datos de la Organización -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Datos de la Organización</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3{% if 'Número Expediente' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.expediente_nro|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'nombre_organizacion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.nombre_organizacion|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'domicilio_organizacion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.domicilio_organizacion|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'localidad_organizacion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.localidad_organizacion|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'partido_organizacion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.partido_organizacion|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'provincia_organizacion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.provincia_organizacion|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'telefono_organizacion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.telefono_organizacion|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'mail_organizacion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.mail_organizacion|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'cuit_organizacion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.cuit_organizacion|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datos del Representante -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Datos del Representante</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3{% if 'representante_nombre' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.representante_nombre|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'representante_cargo' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.representante_cargo|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'representante_dni' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.representante_dni|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datos del Espacio -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Datos del Comedor/Merendero</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3{% if 'tipo_espacio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.tipo_espacio|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'nombre_espacio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.nombre_espacio|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'domicilio_espacio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.domicilio_espacio|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'barrio_espacio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.barrio_espacio|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'localidad_espacio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.localidad_espacio|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'partido_espacio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.partido_espacio|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'provincia_espacio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.provincia_espacio|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'domicilio_electronico_espacio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.domicilio_electronico_espacio|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Responsable de Tarjeta -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Responsable de la Tarjeta</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3{% if 'responsable_tarjeta_nombre' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.responsable_tarjeta_nombre|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'responsable_tarjeta_mail' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.responsable_tarjeta_mail|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'responsable_tarjeta_dni' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.responsable_tarjeta_dni|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'responsable_tarjeta_cuit' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.responsable_tarjeta_cuit|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'responsable_tarjeta_domicilio' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.responsable_tarjeta_domicilio|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'responsable_tarjeta_localidad' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.responsable_tarjeta_localidad|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'responsable_tarjeta_provincia' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.responsable_tarjeta_provincia|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'responsable_tarjeta_telefono' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.responsable_tarjeta_telefono|as_crispy_field }}
                        </div>

                    </div>
                </div>
            </div>

            <!-- Solicitudes por Día -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Solicitudes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle text-center mb-0">
                            <thead class="table-dark">
                                <tr class="text-uppercase small">
                                    <th scope="col" class="fw-semibold">Comida</th>
                                    <th scope="col">Lun</th>
                                    <th scope="col">Mar</th>
                                    <th scope="col">Mié</th>
                                    <th scope="col">Jue</th>
                                    <th scope="col">Vie</th>
                                    <th scope="col">Sáb</th>
                                    <th scope="col">Dom</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th scope="row" class="text-nowrap fw-semibold">Desayuno</th>
                                    <td class="p-1">{{ form.solicitudes_desayuno_lunes }}</td>
                                    <td class="p-1">{{ form.solicitudes_desayuno_martes }}</td>
                                    <td class="p-1">{{ form.solicitudes_desayuno_miercoles }}</td>
                                    <td class="p-1">{{ form.solicitudes_desayuno_jueves }}</td>
                                    <td class="p-1">{{ form.solicitudes_desayuno_viernes }}</td>
                                    <td class="p-1">{{ form.solicitudes_desayuno_sabado }}</td>
                                    <td class="p-1">{{ form.solicitudes_desayuno_domingo }}</td>
                                </tr>
                                <tr>
                                    <th scope="row" class="text-nowrap fw-semibold">Almuerzo</th>
                                    <td class="p-1">{{ form.solicitudes_almuerzo_lunes }}</td>
                                    <td class="p-1">{{ form.solicitudes_almuerzo_martes }}</td>
                                    <td class="p-1">{{ form.solicitudes_almuerzo_miercoles }}</td>
                                    <td class="p-1">{{ form.solicitudes_almuerzo_jueves }}</td>
                                    <td class="p-1">{{ form.solicitudes_almuerzo_viernes }}</td>
                                    <td class="p-1">{{ form.solicitudes_almuerzo_sabado }}</td>
                                    <td class="p-1">{{ form.solicitudes_almuerzo_domingo }}</td>
                                </tr>
                                <tr>
                                    <th scope="row" class="text-nowrap fw-semibold">Merienda</th>
                                    <td class="p-1">{{ form.solicitudes_merienda_lunes }}</td>
                                    <td class="p-1">{{ form.solicitudes_merienda_martes }}</td>
                                    <td class="p-1">{{ form.solicitudes_merienda_miercoles }}</td>
                                    <td class="p-1">{{ form.solicitudes_merienda_jueves }}</td>
                                    <td class="p-1">{{ form.solicitudes_merienda_viernes }}</td>
                                    <td class="p-1">{{ form.solicitudes_merienda_sabado }}</td>
                                    <td class="p-1">{{ form.solicitudes_merienda_domingo }}</td>
                                </tr>
                                <tr>
                                    <th scope="row" class="text-nowrap fw-semibold">Cena</th>
                                    <td class="p-1">{{ form.solicitudes_cena_lunes }}</td>
                                    <td class="p-1">{{ form.solicitudes_cena_martes }}</td>
                                    <td class="p-1">{{ form.solicitudes_cena_miercoles }}</td>
                                    <td class="p-1">{{ form.solicitudes_cena_jueves }}</td>
                                    <td class="p-1">{{ form.solicitudes_cena_viernes }}</td>
                                    <td class="p-1">{{ form.solicitudes_cena_sabado }}</td>
                                    <td class="p-1">{{ form.solicitudes_cena_domingo }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prestaciones Aprobadas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Prestaciones Aprobadas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle text-center mb-0">
                            <thead class="table-dark">
                                <tr class="text-uppercase small">
                                    <th scope="col" class="fw-semibold">Comida</th>
                                    <th scope="col">Lun</th>
                                    <th scope="col">Mar</th>
                                    <th scope="col">Mié</th>
                                    <th scope="col">Jue</th>
                                    <th scope="col">Vie</th>
                                    <th scope="col">Sáb</th>
                                    <th scope="col">Dom</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th>Desayuno</th>
                                    <td class="p-1">{{ form.aprobadas_desayuno_lunes }}</td>
                                    <td class="p-1">{{ form.aprobadas_desayuno_martes }}</td>
                                    <td class="p-1">{{ form.aprobadas_desayuno_miercoles }}</td>
                                    <td class="p-1">{{ form.aprobadas_desayuno_jueves }}</td>
                                    <td class="p-1">{{ form.aprobadas_desayuno_viernes }}</td>
                                    <td class="p-1">{{ form.aprobadas_desayuno_sabado }}</td>
                                    <td class="p-1">{{ form.aprobadas_desayuno_domingo }}</td>
                                </tr>
                                <tr>
                                    <th>Almuerzo</th>
                                    <td class="p-1">{{ form.aprobadas_almuerzo_lunes }}</td>
                                    <td class="p-1">{{ form.aprobadas_almuerzo_martes }}</td>
                                    <td class="p-1">{{ form.aprobadas_almuerzo_miercoles }}</td>
                                    <td class="p-1">{{ form.aprobadas_almuerzo_jueves }}</td>
                                    <td class="p-1">{{ form.aprobadas_almuerzo_viernes }}</td>
                                    <td class="p-1">{{ form.aprobadas_almuerzo_sabado }}</td>
                                    <td class="p-1">{{ form.aprobadas_almuerzo_domingo }}</td>
                                </tr>
                                <tr>
                                    <th>Merienda</th>
                                    <td class="p-1">{{ form.aprobadas_merienda_lunes }}</td>
                                    <td class="p-1">{{ form.aprobadas_merienda_martes }}</td>
                                    <td class="p-1">{{ form.aprobadas_merienda_miercoles }}</td>
                                    <td class="p-1">{{ form.aprobadas_merienda_jueves }}</td>
                                    <td class="p-1">{{ form.aprobadas_merienda_viernes }}</td>
                                    <td class="p-1">{{ form.aprobadas_merienda_sabado }}</td>
                                    <td class="p-1">{{ form.aprobadas_merienda_domingo }}</td>
                                </tr>
                                <tr>
                                    <th>Cena</th>
                                    <td class="p-1">{{ form.aprobadas_cena_lunes }}</td>
                                    <td class="p-1">{{ form.aprobadas_cena_martes }}</td>
                                    <td class="p-1">{{ form.aprobadas_cena_miercoles }}</td>
                                    <td class="p-1">{{ form.aprobadas_cena_jueves }}</td>
                                    <td class="p-1">{{ form.aprobadas_cena_viernes }}</td>
                                    <td class="p-1">{{ form.aprobadas_cena_sabado }}</td>
                                    <td class="p-1">{{ form.aprobadas_cena_domingo }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Información Adicional -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Información Adicional</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3{% if 'total_acreditaciones' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.total_acreditaciones|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'plazo_ejecucion' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.plazo_ejecucion|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'nota_gde_if' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.nota_gde_if|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'constancia_subsidios_dnsa' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.constancia_subsidios_dnsa|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'constancia_subsidios_pnud' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.constancia_subsidios_pnud|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'partido_poblacion_destinataria' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.partido_poblacion_destinataria|as_crispy_field }}
                        </div>
                        <div class="col-md-6 mb-3{% if 'provincia_poblacion_destinataria' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.provincia_poblacion_destinataria|as_crispy_field }}
                        </div>

                        <div class="col-md-6 mb-3{% if 'fecha_vencimiento_mandatos' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.fecha_vencimiento_mandatos|as_crispy_field }}
                        </div>
                        <div class="col-12 mb-3{% if 'conclusiones' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                            {{ form.conclusiones|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campos específicos según tipo -->
            {% if tipo == 'base' %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Campos Específicos - Organización de Base</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3{% if 'declaracion_jurada_recepcion_subsidios' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.declaracion_jurada_recepcion_subsidios|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'constancia_inexistencia_percepcion_otros_subsidios' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.constancia_inexistencia_percepcion_otros_subsidios|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'organizacion_avalista_1' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.organizacion_avalista_1|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'organizacion_avalista_2' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.organizacion_avalista_2|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'material_difusion_vinculado' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.material_difusion_vinculado|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'if_relevamiento' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.if_relevamiento|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>
            {% elif tipo == 'juridico' %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Campos Específicos - Organización Jurídica</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3{% if 'validacion_registro_nacional' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.validacion_registro_nacional|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'IF_relevamiento_territorial' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.IF_relevamiento_territorial|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            <!-- Campos específicos para Renovación -->
            {% if admision.tipo and admision.tipo == 'renovacion' %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Resolución de pago</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3{% if 'resolucion_de_pago_1' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.resolucion_de_pago_1|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'monto_1' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.monto_1|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'resolucion_de_pago_2' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.resolucion_de_pago_2|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'monto_2' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.monto_2|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'resolucion_de_pago_3' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.resolucion_de_pago_3|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'monto_3' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.monto_3|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'resolucion_de_pago_4' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.resolucion_de_pago_4|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'monto_4' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.monto_4|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'resolucion_de_pago_5' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.resolucion_de_pago_5|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'monto_5' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.monto_5|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'resolucion_de_pago_6' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.resolucion_de_pago_6|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3{% if 'monto_6' in campos_a_subsanar %} border border-danger rounded p-2{% endif %}">
                                {{ form.monto_6|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Botones -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'admisiones_tecnicos_editar' admision.id %}"
                           class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                        <div>
                            <button type="submit"
                                    name="action"
                                    value="draft"
                                    class="btn btn-primary me-2">
                                <i class="fas fa-save"></i> Guardar Borrador
                            </button>
                            <button type="submit" name="action" value="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> Finalizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock %}
