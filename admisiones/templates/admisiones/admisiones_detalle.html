{% extends "includes/main.html" %}
{% load static %}
{% load admisiones_tags %}
{% load estado_filters %}

{% block title %}Admision {{ admision.id }}{% endblock %}
{% block titulo-pagina %}
    Detalle de Admision
    {% if admision.activa %}
        <span class="badge bg-success">Activa</span>
    {% else %}
        <span class="badge bg-danger">Cerrada</span>
    {% endif %}
{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item">
            <a href="{% url 'comedores' %}">Comedores</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'comedor_detalle' comedor.id %}">{{ comedor.nombre }}</a>
        </li>
        <li class="breadcrumb-item active">Admision</li>
    </ol>
{% endblock %}

{% block content %}
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between flex-wrap gap-2">
            <a href="{% url 'comedor_detalle' comedor.id %}"
               class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al comedor
            </a>
            {% if admision.activa %}
                {% if user.is_superuser %}
                    <button type="button"
                            class="btn btn-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#forzarCierreModal">
                        <i class="fas fa-times-circle me-2"></i>Forzar Cierre
                    </button>
                {% else %}
                    {% for group in user.groups.all %}
                        {% if group.name == "Coordinador Equipo Tecnico" %}
                            <button type="button"
                                    class="btn btn-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#forzarCierreModal">
                                <i class="fas fa-times-circle me-2"></i>Forzar Cierre
                            </button>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="card card-primary card-outline mb-4">
        <div class="card-header">
            <h3 class="card-title">Admision</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-6">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Fecha de creacion</dt>
                        <dd class="col-sm-7">
                            {{ admision.creado|date:"d/m/Y"|default:"-" }}
                        </dd>
                        <dt class="col-sm-5">Tipo</dt>
                        <dd class="col-sm-7">
                            {{ admision.get_tipo_display|default:"-" }}
                        </dd>
                        <dt class="col-sm-5">Tipo de convenio</dt>
                        <dd class="col-sm-7">
                            {{ admision.tipo_convenio.nombre|default:"-" }}
                        </dd>
                        <dt class="col-sm-5">Numero de convenio</dt>
                        <dd class="col-sm-7">
                            {% if puede_editar_convenio_numero %}
                                <div class="d-inline-flex align-items-center gap-2">
                                    <div id="convenio-numero-display"
                                         class="convenio-numero-display"
                                         onclick="activarEdicionConvenioNumero()">
                                        {% if admision.convenio_numero is not None %}
                                            <span class="text-success fw-bold">{{ admision.convenio_numero }}</span>
                                            <i class="bi bi-pencil-square ms-2 text-muted"
                                               title="Editar numero de convenio"></i>
                                        {% else %}
                                            <span class="text-muted">Sin numero de convenio</span>
                                            <i class="bi bi-plus-circle ms-2 text-primary"
                                               title="Agregar numero de convenio"></i>
                                        {% endif %}
                                    </div>
                                    <div id="convenio-numero-edit" class="convenio-numero-edit d-none">
                                        <input type="number"
                                               id="convenio-numero-input"
                                               class="form-control form-control-sm"
                                               value="{{ admision.convenio_numero|default_if_none:'' }}"
                                               min="0"
                                               step="1" />
                                        <button type="button"
                                                class="btn btn-success btn-sm convenio-numero-btn"
                                                onclick="guardarConvenioNumero()"
                                                title="Guardar">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        <button type="button"
                                                class="btn btn-danger btn-sm convenio-numero-btn"
                                                onclick="cancelarEdicionConvenioNumero()"
                                                title="Cancelar">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                                <span class="fw-bold">{{ admision.convenio_numero|default_if_none:"-" }}</span>
                            {% endif %}
                        </dd>
                        <dt class="col-sm-5">Estado Actual</dt>
                        <dd class="col-sm-7">
                            {{ admision.estado_mostrar|default:"-" }}
                        </dd>
                        <dt class="col-sm-5">Fecha Estado</dt>
                        <dd class="col-sm-7">
                            {{ admision.fecha_estado_mostrar|date:"d/m/Y"|default:"-" }}
                        </dd>
                        <dt class="col-sm-5">Estado legales</dt>
                        <dd class="col-sm-7">
                            {{ admision.get_estado_legales_display|default:"-" }}
                        </dd>
                    </dl>
                </div>
                <div class="col-lg-6">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Enviado a legales</dt>
                        <dd class="col-sm-7">
                            {{ admision.enviado_legales|yesno:"Si,No" }}
                        </dd>
                        <dt class="col-sm-5">Enviado a acompanamiento</dt>
                        <dd class="col-sm-7">
                            {{ admision.enviado_acompaniamiento|yesno:"Si,No" }}
                        </dd>
                        <dt class="col-sm-5">Numero expediente</dt>
                        <dd class="col-sm-7">
                            {{ admision.num_expediente|default:"-" }}
                        </dd>
                        {% if not admision.activa %}
                            <dt class="col-sm-5">Fecha de cierre</dt>
                            <dd class="col-sm-7">
                                {{ admision.modificado|date:"d/m/Y" }}
                            </dd>
                            <dt class="col-sm-5">Motivo de cierre</dt>
                            <dd class="col-sm-7">
                                {% if admision.motivo_descarte_expediente %}
                                    {{ admision.motivo_descarte_expediente }}
                                {% elif admision.motivo_forzar_cierre %}
                                    {{ admision.motivo_forzar_cierre }}
                                {% else %}
                                    -
                                {% endif %}
                            </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            <hr class="my-4" />

            <h5 class="mb-3">Dupla asignada</h5>
            {% if dupla %}
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1">
                            <strong>Nombre:</strong> {{ dupla.nombre }}
                        </p>
                        <p class="mb-1">
                            <strong>Estado:</strong> {{ dupla.estado }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1">
                            <strong>Abogado/a:</strong>
                            {{ dupla_abogado.get_full_name|default:dupla_abogado.username|default:"-" }}
                        </p>
                        <p class="mb-0">
                            <strong>Integrantes tecnicos:</strong>
                            {% if dupla_tecnicos %}
                                {{ dupla_tecnicos|join:", " }}
                            {% else %}
                                -
                            {% endif %}
                        </p>
                    </div>
                </div>
            {% else %}
                <p class="text-muted">No hay dupla asignada actualmente.</p>
            {% endif %}
        </div>
    </div>

    <div class="card card-outline card-secondary mb-4">
        <div class="card-header">
            <h3 class="card-title">Documentacion de admision</h3>
        </div>
        <div class="card-body table-responsive">
            {% if documentos or documentos_personalizados %}
                <table class="table table-striped table-bordered align-middle">
                    <thead>
                        <tr>
                            <th>Documento</th>
                            <th>Obligatorio</th>
                            <th>Estado</th>
                            <th>Numero IF / GDE</th>
                            <th>Archivo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documentos %}
                            <tr>
                                <td>{{ doc.nombre }}</td>
                                <td>{{ doc.obligatorio|yesno:"Si,No" }}</td>
                                <td>{{ doc.estado|default:"-" }}</td>
                                <td>{{ doc.numero_gde|default:"-" }}</td>
                                <td class="text-center">
                                    {% if doc.archivo_url %}
                                        <a href="{{ doc.archivo_url }}"
                                           class="btn btn-outline-primary btn-sm"
                                           target="_blank"
                                           rel="noopener">Descargar</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        {% for doc in documentos_personalizados %}
                            <tr>
                                <td>{{ doc.nombre }}</td>
                                <td>No</td>
                                <td>{{ doc.estado|default:"-" }}</td>
                                <td>{{ doc.numero_gde|default:"-" }}</td>
                                <td class="text-center">
                                    {% if doc.archivo_url %}
                                        <a href="{{ doc.archivo_url }}"
                                           class="btn btn-outline-primary btn-sm"
                                           target="_blank"
                                           rel="noopener">Descargar</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted mb-0">No hay documentos cargados para esta admision.</p>
            {% endif %}
        </div>
    </div>

    <div class="card card-outline card-secondary mb-4">
        <div class="card-header">
            <h3 class="card-title">Archivos adicionales</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover table-sm"
                       id="tablaArchivosAdicionales">
                    <thead>
                        <tr>
                            <th>Documento</th>
                            <th>Archivo</th>
                            <th>Número de GDE</th>
                        </tr>
                    </thead>
                    <tbody id="tablaArchivosAdicionalesBody">
                        {% for doc in documentos_personalizados %}
                            <tr>
                                <td>{{ doc.nombre }}</td>
                                <td class="text-center">
                                    {% if doc.archivo_url %}
                                        <a href="{{ doc.archivo_url }}"
                                           class="btn btn-outline-primary btn-sm"
                                           target="_blank"
                                           rel="noopener">Descargar</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ doc.numero_gde|default:"-" }}</td>
                            </tr>
                        {% endfor %}
                        {% if admision.activa %}
                            <tr id="fila-agregar-archivo-adicional">
                                <td class="ps-1">
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="nuevoArchivoNombre"
                                           placeholder="Nombre del archivo adicional" />
                                </td>
                                <td>
                                    <input type="file" id="nuevoArchivoFile" class="d-none" />
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary"
                                            id="btnAbrirArchivoFile">Adjuntar</button>
                                    <div class="progress mt-2"
                                         id="progress-container-archivo"
                                         style="display:none;
                                                height:3px">
                                        <div class="progress-bar progress-bar-striped"
                                             role="progressbar"
                                             id="progress-bar-archivo"
                                             style="width:0%">0%</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="text-muted">-</span>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card card-outline card-secondary mb-4">
        <div class="card-header">
            <h3 class="card-title">Informes tecnicos</h3>
        </div>
        <div class="card-body">
            <h5>Informe tecnico principal</h5>
            {% if informe_tecnico %}
                <div class="row">
                    <div class="col-lg-6">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Expediente</dt>
                            <dd class="col-sm-7">
                                {{ informe_tecnico.expediente_nro|default:"-" }}
                            </dd>
                            <dt class="col-sm-5">Nota GDE IF</dt>
                            <dd class="col-sm-7">
                                {{ informe_tecnico.nota_gde_if|default:"-" }}
                            </dd>
                            <dt class="col-sm-5">IF relevamiento</dt>
                            <dd class="col-sm-7">
                                {{ informe_tecnico.if_relevamiento|default:"-" }}
                            </dd>
                            <dt class="col-sm-5">Vencimiento mandatos</dt>
                            <dd class="col-sm-7">
                                {{ informe_tecnico.fecha_vencimiento_mandatos|date:"d/m/Y"|default:"-" }}
                            </dd>
                        </dl>
                    </div>
                    <div class="col-lg-6">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Estado formulario</dt>
                            <dd class="col-sm-7">
                                {{ informe_tecnico.estado_formulario|default:"-" }}
                            </dd>
                            <dt class="col-sm-5">Tipo</dt>
                            <dd class="col-sm-7">
                                {{ informe_tecnico.get_tipo_display|default:"-" }}
                            </dd>
                            <dt class="col-sm-5">Responsable tarjeta</dt>
                            <dd class="col-sm-7">
                                {{ informe_tecnico.responsable_tarjeta_nombre|default:"-" }}
                            </dd>
                            <dt class="col-sm-5">CUIT responsable</dt>
                            <dd class="col-sm-7">
                                {{ informe_tecnico.responsable_tarjeta_cuit|default:"-" }}
                            </dd>
                        </dl>
                    </div>
                </div>
                <div class="mt-3">
                    {% if informe_tecnico_pdf %}
                        {% if informe_tecnico.estado == "Validado" %}
                            {% if informe_tecnico_pdf.archivo_docx_editado %}
                                <a href="{{ informe_tecnico_pdf.archivo_docx_editado.url }}"
                                   class="btn btn-success btn-sm me-2"
                                   target="_blank"
                                   rel="noopener">Descargar Informe SISOC Final</a>
                            {% elif informe_tecnico_pdf.archivo_docx %}
                                <a href="{{ informe_tecnico_pdf.archivo_docx.url }}"
                                   class="btn btn-outline-primary btn-sm me-2"
                                   target="_blank"
                                   rel="noopener">Descargar Word</a>
                            {% endif %}
                        {% else %}
                            <a href="{{ informe_tecnico_pdf.archivo.url }}"
                               class="btn btn-outline-primary btn-sm me-2"
                               target="_blank"
                               rel="noopener">Descargar PDF</a>
                            {% if informe_tecnico_pdf.archivo_docx %}
                                <a href="{{ informe_tecnico_pdf.archivo_docx.url }}"
                                   class="btn btn-outline-primary btn-sm"
                                   target="_blank"
                                   rel="noopener">Descargar Word</a>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        <p class="text-muted mb-0">No hay archivos generados para el informe tecnico.</p>
                    {% endif %}
                </div>
            {% else %}
                <p class="text-muted">No se registran informes tecnicos cargados.</p>
            {% endif %}
            <hr class="my-4" />
            {% if admision.numero_if_tecnico or admision.archivo_informe_tecnico_GDE %}
                <div class="mt-2">
                    <span class="fw-bold">Informe Técnico GDE:</span>
                    <span>{{ admision.numero_if_tecnico|default:"-" }}</span>
                    {% if admision.archivo_informe_tecnico_GDE %}
                        <a href="{{ admision.archivo_informe_tecnico_GDE.url }}"
                           class="btn btn-success btn-sm me-2 ms-3"
                           target="_blank"
                           rel="noopener">Descargar Informe Técnico GDE</a>
                    {% endif %}
                </div>
            {% endif %}
            <hr class="my-4" />

            <h5>Informes tecnicos complementarios</h5>
            {% if informes_complementarios %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Observaciones</th>
                                <th>PDF</th>
                                <th>PDF final</th>
                                <th>Word final</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comp in informes_complementarios %}
                                <tr>
                                    <td>{{ comp.creado|date:"d/m/Y"|default:"-" }}</td>
                                    <td>{{ comp.get_estado_display|default:"-" }}</td>
                                    <td>{{ comp.observaciones_legales|default:"-" }}</td>
                                    <td class="text-center">
                                        {% if comp.pdf %}
                                            <a href="{{ comp.pdf.url }}"
                                               class="btn btn-outline-primary btn-sm"
                                               target="_blank"
                                               rel="noopener">Descargar</a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if comp.pdf_final %}
                                            <a href="{{ comp.pdf_final.archivo.url }}"
                                               class="btn btn-outline-primary btn-sm"
                                               target="_blank"
                                               rel="noopener">Descargar</a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if comp.pdf_final and comp.pdf_final.archivo_docx %}
                                            <a href="{{ comp.pdf_final.archivo_docx.url }}"
                                               class="btn btn-outline-primary btn-sm"
                                               target="_blank"
                                               rel="noopener">Descargar</a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-0">No se registran informes complementarios.</p>
            {% endif %}
        </div>
    </div>

    <div class="card card-outline card-secondary mb-4">
        <div class="card-header">
            <h3 class="card-title">Historial de estados</h3>
        </div>
        <div class="card-body">
            {% include 'components/data_table.html' with headers=historial_estados_headers items=historial_estados_items custom_cells=True show_actions=False empty_message='No se registran cambios de estado.' include_pagination=True page_obj=historial_estados_page_obj is_paginated=historial_estados_is_paginated page_param=historial_estados_page_param %}
        </div>
    </div>

    <div class="card card-outline card-success mb-4">
        <div class="card-header">
            <h3 class="card-title">Acompanamiento</h3>
        </div>
        <div class="card-body">
            <h5>Informacion relevante</h5>
            <div class="row">
                <div class="col-lg-6">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">Numero de expediente</dt>
                        <dd class="col-sm-6">
                            {% if acompanamiento_info %}
                                {{ acompanamiento_info.expediente_nro|default:"-" }}
                            {% else %}
                                -
                            {% endif %}
                        </dd>
                        <dt class="col-sm-6">Numero de disposicion</dt>
                        <dd class="col-sm-6">
                            {{ acompanamiento_numero_disposicion|default:"-" }}
                        </dd>
                        <dt class="col-sm-6">IF de relevamiento</dt>
                        <dd class="col-sm-6">
                            {% if acompanamiento_info %}
                                {{ acompanamiento_info.if_relevamiento|default:"-" }}
                            {% else %}
                                -
                            {% endif %}
                        </dd>
                    </dl>
                </div>
                <div class="col-lg-6">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">Vencimiento de mandato</dt>
                        <dd class="col-sm-6">
                            {% if acompanamiento_info %}
                                {{ acompanamiento_info.fecha_vencimiento_mandatos|date:"d/m/Y"|default:"-" }}
                            {% else %}
                                -
                            {% endif %}
                        </dd>
                        <dt class="col-sm-6">Codigo de proyecto</dt>
                        <dd class="col-sm-6">
                            {{ comedor.codigo_de_proyecto|default:"-" }}
                        </dd>
                        <dt class="col-sm-6">IF asociados</dt>
                        <dd class="col-sm-6">
                            {{ acompanamiento_numero_if|default:"-" }}
                        </dd>
                    </dl>
                </div>
            </div>

            {% if prestaciones_por_dia %}
                <hr class="my-4" />
                <h5>Prestaciones registradas</h5>
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-bordered text-center align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Tipo de comida</th>
                                {% for dia in dias_semana %}<th>{{ dia }}</th>{% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for prestacion in prestaciones_por_dia %}
                                <tr>
                                    <td class="text-start">{{ prestacion.tipo }}</td>
                                    {% for dia in dias_semana %}
                                        {% with dia_lower=dia|lower %}<td>{{ prestacion|get_item:dia_lower|default:"-" }}</td>{% endwith %}
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Tipo de comida</th>
                                <th>Total semanal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for total in prestaciones_dias %}
                                <tr>
                                    <td>{{ total.tipo }}</td>
                                    <td>{{ total.cantidad|default:"-" }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}

            <hr class="my-4" />

            <h5>Expedientes de pago</h5>
            {% if expedientes_pagos %}
                <div class="table-responsive mb-3">
                    <table class="table table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Expediente</th>
                                <th>Expediente del convenio</th>
                                <th>IF prestaciones</th>
                                <th>Monto</th>
                                <th>Orden de pago</th>
                                <th>Fecha banco</th>
                                <th>Fecha acreditacion</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expediente in expedientes_pagos %}
                                <tr>
                                    <td>{{ expediente.expediente_pago|default:"-" }}</td>
                                    <td>{{ expediente.expediente_convenio|default:"-" }}</td>
                                    <td>{{ expediente.if_cantidad_de_prestaciones|default:"-" }}</td>
                                    <td>{{ expediente.monto|default:"-" }}</td>
                                    <td>{{ expediente.numero_orden_pago|default:"-" }}</td>
                                    <td>{{ expediente.fecha_pago_al_banco|date:"d/m/Y"|default:"-" }}</td>
                                    <td>{{ expediente.fecha_acreditacion|date:"d/m/Y"|default:"-" }}</td>
                                    <td class="text-center">
                                        <a href="{% url 'expedientespagos_detail' expediente.id %}"
                                           class="btn btn-outline-primary btn-sm">Ver</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No se registran expedientes de pago.</p>
            {% endif %}

            <h5 class="mt-4">Seguimientos mensuales</h5>
            {% if rendiciones_mensuales %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th>Ano</th>
                                <th>Documento adjunto</th>
                                <th>Observaciones</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rendicion in rendiciones_mensuales %}
                                <tr>
                                    <td>{{ rendicion.get_mes_display|default:"-" }}</td>
                                    <td>{{ rendicion.anio|default:"-" }}</td>
                                    <td>{{ rendicion.documento_adjunto|yesno:"Si,No" }}</td>
                                    <td>{{ rendicion.observaciones|default:"-" }}</td>
                                    <td class="text-center">
                                        <a href="{% url 'rendicioncuentasmensual_detail' rendicion.id %}"
                                           class="btn btn-outline-primary btn-sm">Ver</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-0">No se registran seguimientos mensuales.</p>
            {% endif %}
        </div>
    </div>

    <div class="card card-outline card-info mb-4">
        <div class="card-header">
            <h3 class="card-title">Rendicion de cuenta final</h3>
        </div>
        <div class="card-body">
            {% if rendicion_final %}
                <p class="mb-3">
                    <strong>Fisicamente presentada:</strong>
                    {{ rendicion_final.fisicamente_presentada|yesno:"Si,No" }}
                </p>

                <h5>Documentos asociados</h5>
                {% if rendicion_final_documentos %}
                    <div class="table-responsive mb-3">
                        <table class="table table-striped table-bordered align-middle">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Observaciones</th>
                                    <th>Ultima actualizacion</th>
                                    <th>Archivo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in rendicion_final_documentos %}
                                    <tr>
                                        <td>{{ doc.tipo.nombre|default:"-" }}</td>
                                        <td>{{ doc.estado.nombre|default:"-" }}</td>
                                        <td>{{ doc.observaciones|default:"-" }}</td>
                                        <td>{{ doc.fecha_modificacion|date:"d/m/Y H:i"|default:"-" }}</td>
                                        <td class="text-center">
                                            {% if doc.documento %}
                                                <a href="{{ doc.documento.url }}"
                                                   class="btn btn-outline-primary btn-sm"
                                                   target="_blank"
                                                   rel="noopener">Descargar</a>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No hay documentos en la rendicion final.</p>
                {% endif %}

                <h5>Historial de rendicion</h5>
                {% if rendicion_final_historial %}
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered align-middle">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Usuario</th>
                                    <th>Accion</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in rendicion_final_historial %}
                                    <tr>
                                        <td>{{ item.fecha|date:"d/m/Y H:i" }}</td>
                                        <td>{{ item.usuario.get_full_name|default:item.usuario.username|default:"-" }}</td>
                                        <td>{{ item.accion }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No hay movimientos registrados en la rendicion final.</p>
                {% endif %}
            {% else %}
                <p class="text-muted mb-0">Todavia no se genero una rendicion de cuenta final para este comedor.</p>
            {% endif %}
        </div>
    </div>

    <!-- Modal Forzar Cierre -->
    <div class="modal fade"
         id="forzarCierreModal"
         tabindex="-1"
         aria-labelledby="forzarCierreModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="forzarCierreModalLabel">Forzar Cierre de Admisión</h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atención:</strong> Esta acción marcará la admisión como inactiva y no se podrá revertir.
                        </div>
                        <div class="mb-3">
                            <label for="motivo_forzar_cierre" class="form-label">
                                Motivo del cierre forzado <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control"
                                      id="motivo_forzar_cierre"
                                      name="motivo_forzar_cierre"
                                      rows="4"
                                      required
                                      placeholder="Ingrese el motivo por el cual se fuerza el cierre de esta admisión..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" name="forzar_cierre" class="btn btn-danger">Confirmar Cierre</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Token CSRF para JavaScript -->
    <form style="display: none;">
        {% csrf_token %}
    </form>
{% endblock %}

{% block customJS %}
    <style>
        .convenio-numero-display {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .convenio-numero-display:hover {
            background-color: #f8f9fa;
        }
        .convenio-numero-edit {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-width: 220px;
        }
        .convenio-numero-edit .btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .convenio-numero-btn {
            width: 28px;
            height: 28px;
        }
        #convenio-numero-input {
            max-width: 140px;
        }
    </style>
    <script>window.URL_ACTUALIZAR_CONVENIO_NUMERO = "{% url 'actualizar_convenio_numero' %}";</script>
    <script>window.ADMISION_ID = {{ admision.id }};</script>
    <script src="{% static 'custom/js/admisionesactualizarestado.js' %}"></script>
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <div id="toastConvenioNumeroExito"
             class="toast align-items-center text-bg-success border-0"
             role="alert"
             aria-live="assertive"
             aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <h6>Numero de convenio actualizado con exito.</h6>
                </div>
                <button type="button"
                        class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"
                        aria-label="Cerrar"></button>
            </div>
        </div>
        <div id="toastConvenioNumeroError"
             class="toast align-items-center text-bg-danger border-0"
             role="alert"
             aria-live="assertive"
             aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <h6 id="toastConvenioNumeroErrorMsg">No se pudo actualizar el numero de convenio.</h6>
                </div>
                <button type="button"
                        class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"
                        aria-label="Cerrar"></button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Funcionalidad para archivos adicionales
            const btnAbrirArchivoFile = document.getElementById('btnAbrirArchivoFile');
            const nuevoArchivoFile = document.getElementById('nuevoArchivoFile');
            const nuevoArchivoNombre = document.getElementById('nuevoArchivoNombre');
            const progressContainer = document.getElementById('progress-container-archivo');
            const progressBar = document.getElementById('progress-bar-archivo');

            if (btnAbrirArchivoFile) {
                btnAbrirArchivoFile.addEventListener('click', function() {
                    nuevoArchivoFile.click();
                });
            }

            if (nuevoArchivoFile) {
                nuevoArchivoFile.addEventListener('change', function() {
                    const file = this.files[0];
                    const nombre = nuevoArchivoNombre.value.trim();
                    
                    if (!file) return;
                    
                    if (!nombre) {
                        alert('Por favor ingrese un nombre para el archivo');
                        return;
                    }

                    // Mostrar barra de progreso
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';

                    // Crear FormData
                    const formData = new FormData();
                    formData.append('archivo', file);
                    formData.append('nombre', nombre);
                    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                    // Realizar upload
                    const xhr = new XMLHttpRequest();
                    
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            progressBar.style.width = percentComplete + '%';
                            progressBar.textContent = Math.round(percentComplete) + '%';
                        }
                    });

                    xhr.addEventListener('load', function() {
                        if (xhr.status === 200) {
                            // Recargar la página para mostrar el nuevo archivo
                            location.reload();
                        } else {
                            alert('Error al subir el archivo');
                            progressContainer.style.display = 'none';
                        }
                    });

                    xhr.addEventListener('error', function() {
                        alert('Error al subir el archivo');
                        progressContainer.style.display = 'none';
                    });

                    // Enviar la petición a la misma URL de la página
                    xhr.open('POST', window.location.href);
                    xhr.send(formData);
                });
            }
        });
    </script>
{% endblock %}
