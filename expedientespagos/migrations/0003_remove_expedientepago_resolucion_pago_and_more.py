# Generated by Django 4.2.20 on 2026-01-26 18:23

from django.db import migrations, models


def drop_resolucion_pago_if_exists(apps, schema_editor):
    table = 'expedientespagos_expedientepago'
    column = 'resolucion_pago'
    connection = schema_editor.connection
    with connection.cursor() as cursor:
        cursor.execute(
            "SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = %s AND COLUMN_NAME = %s",
            [table, column],
        )
        exists = cursor.fetchone()[0] > 0
    if exists:
        with connection.cursor() as cursor:
            cursor.execute(f"ALTER TABLE `{table}` DROP COLUMN `{column}`")


def add_column_if_missing(schema_editor, table, column, definition_sql):
    connection = schema_editor.connection
    with connection.cursor() as cursor:
        cursor.execute(
            "SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = %s AND COLUMN_NAME = %s",
            [table, column],
        )
        exists = cursor.fetchone()[0] > 0
    if not exists:
        with connection.cursor() as cursor:
            cursor.execute(f"ALTER TABLE `{table}` ADD COLUMN `{column}` {definition_sql}")


def add_monto_mensual_almuerzo(apps, schema_editor):
    add_column_if_missing(schema_editor, 'expedientespagos_expedientepago', 'monto_mensual_almuerzo', 'DECIMAL(10,2) NULL')


def add_monto_mensual_cena(apps, schema_editor):
    add_column_if_missing(schema_editor, 'expedientespagos_expedientepago', 'monto_mensual_cena', 'DECIMAL(10,2) NULL')


def add_monto_mensual_desayuno(apps, schema_editor):
    add_column_if_missing(schema_editor, 'expedientespagos_expedientepago', 'monto_mensual_desayuno', 'DECIMAL(10,2) NULL')


def add_monto_mensual_merienda(apps, schema_editor):
    add_column_if_missing(schema_editor, 'expedientespagos_expedientepago', 'monto_mensual_merienda', 'DECIMAL(10,2) NULL')


def add_prestaciones_mensuales_almuerzo(apps, schema_editor):
    add_column_if_missing(schema_editor, 'expedientespagos_expedientepago', 'prestaciones_mensuales_almuerzo', 'INT NULL')


def add_prestaciones_mensuales_cena(apps, schema_editor):
    add_column_if_missing(schema_editor, 'expedientespagos_expedientepago', 'prestaciones_mensuales_cena', 'INT NULL')


def add_prestaciones_mensuales_desayuno(apps, schema_editor):
    add_column_if_missing(schema_editor, 'expedientespagos_expedientepago', 'prestaciones_mensuales_desayuno', 'INT NULL')


def add_prestaciones_mensuales_merienda(apps, schema_editor):
    add_column_if_missing(schema_editor, 'expedientespagos_expedientepago', 'prestaciones_mensuales_merienda', 'INT NULL')


class Migration(migrations.Migration):

    dependencies = [
        ("expedientespagos", "0002_alter_expedientepago_expediente_pago_and_more"),
    ]

    operations = [
        # En entornos donde el otro branch ya agreg√≥ 'expediente_convenio',
        # renombrar puede fallar. Eliminamos el campo antiguo con SQL tolerante.
        migrations.RunPython(drop_resolucion_pago_if_exists, migrations.RunPython.noop),
        # No alter on expediente_convenio here to avoid dependency on field order
        migrations.RunPython(add_monto_mensual_almuerzo, migrations.RunPython.noop),
        migrations.RunPython(add_monto_mensual_cena, migrations.RunPython.noop),
        migrations.RunPython(add_monto_mensual_desayuno, migrations.RunPython.noop),
        migrations.RunPython(add_monto_mensual_merienda, migrations.RunPython.noop),
        migrations.RunPython(add_prestaciones_mensuales_almuerzo, migrations.RunPython.noop),
        migrations.RunPython(add_prestaciones_mensuales_cena, migrations.RunPython.noop),
        migrations.RunPython(add_prestaciones_mensuales_desayuno, migrations.RunPython.noop),
        migrations.RunPython(add_prestaciones_mensuales_merienda, migrations.RunPython.noop),
    ]
