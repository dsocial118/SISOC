{% load custom_filters static %}
<link rel="stylesheet"
      href="{% static 'custom/css/comedoresSearchBar.css' %}" />
{% comment %}
Componente Search Bar
Uso clásico (texto): {% include 'components/search_bar.html' with titulo='Mi Título' placeholder='Buscar...' help_text='Ayuda' reset_url=url add_url=url show_add_button=True query=query add_text='Agregar' %}
Modo filtros combinables: {% include 'components/search_bar.html' with titulo='Buscar' reset_url=reset_url add_url=add_url filters_mode=True %}
Modo búsqueda AJAX dinámica: {% include 'components/search_bar.html' with titulo='Buscar' placeholder='Buscar...' reset_url=reset_url add_url=add_url ajax_search_mode=True ajax_url=ajax_url target_tbody_id='table-tbody' %}
{% endcomment %}
{% firstof filters_mode comedores_filters_mode False as filters_mode_value %}
{% with filters_mode=filters_mode_value %}
    <h2 class="text-center display-4 mb-4">{{ titulo|default:"Buscar" }}</h2>
    {% if ajax_search_mode %}
        <!-- Modo búsqueda AJAX dinámica -->
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <div class="form-group">
                    <div class="input-group input-group-lg">
                        <input type="search"
                               id="ajax-search-input"
                               class="form-control form-control-lg"
                               placeholder="{{ placeholder|default:'Buscar' }}"
                               title="{{ help_text|default:'Ingrese términos de búsqueda' }}"
                               autocomplete="off"
                               value="{{ query|default:'' }}" />
                    </div>
                    <small class="form-text text-muted">
                        <span id="ajax-results-count"></span>
                    </small>
                </div>
            </div>
        </div>
        <!-- Indicador de carga para AJAX -->
        <div id="ajax-loading-indicator"
             class="text-center py-3"
             style="display: none">
            <div class="spinner-border" role="status">
                <span class="sr-only">Cargando...</span>
            </div>
        </div>
    {% elif filters_mode %}
        {% if filters_config %}{{ filters_config|json_script:"filters-config-json" }}{% endif %}
        <form method="GET"
              action="{{ filters_action|default:'' }}"
              id="filters-form"
              class="ms-5"
              {% if filters_config %}data-config-id="filters-config-json"{% endif %}>
            <div class="row">
                <div class="col-md-10 offset-md-1">
                    <div class="form-group">
                        <div class="d-flex align-items-center mb-2">
                            <label class="me-2 mb-0">Combinar filtros con</label>
                            <select id="filters-logic"
                                    class="form-select form-select-sm"
                                    style="width: auto">
                                <option value="AND" selected>AND</option>
                                <option value="OR">OR</option>
                            </select>
                            <button type="button"
                                    id="add-filter"
                                    class="btn btn-sm btn-outline-success ms-2">Agregar filtro</button>
                        </div>
                        <div id="filters-rows" class="mb-2"></div>
                        <input type="hidden" name="filters" id="filters-input" />
                    </div>
                </div>
            </div>
        </form>
    {% else %}
        <form method="GET"
              action="{{ search_action|default:'' }}"
              id="simple-search-form">
            <div class="row">
                <div class="col-md-10 offset-md-1">
                    <div class="form-group">
                        <div class="input-group input-group-lg">
                            <input type="search"
                                   id="ajax-search-input"
                                   name="busqueda"
                                   class="form-control form-control-lg"
                                   placeholder="{{ placeholder|default:'Buscar' }}"
                                   title="{{ help_text|default:'Ingrese términos de búsqueda' }}"
                                   autocomplete="off"
                                   value="{{ query|default:'' }}" />
                        </div>
                        <small class="form-text text-muted">
                            <span id="ajax-results-count"></span>
                        </small>
                    </div>
                </div>
            </div>
            <!-- Indicador de carga para AJAX -->
            <div id="ajax-loading-indicator"
                 class="text-center py-3"
                 style="display: none">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Cargando...</span>
                </div>
            </div>
        </form>
    {% endif %}
    <div class="row mt-3">
        <div class="col-12 d-flex flex-wrap justify-content-center gap-2 search-actions">
            {% if reset_url_full %}
                <a href="{{ reset_url_full }}" class="btn btn-secondary btn-lg">Resetear</a>
            {% elif reset_url|is_url %}
                <a href="{{ reset_url }}" class="btn btn-secondary btn-lg">Resetear</a>
            {% else %}
                <a href="{% url reset_url %}" class="btn btn-secondary btn-lg">Resetear</a>
            {% endif %}
            {% if add_url and show_add_button|default:True %}
                {% if add_url_full %}
                    <a href="{{ add_url_full }}" class="btn btn-primary btn-lg">{{ add_text|default:"Agregar" }}</a>
                {% elif add_url|is_url %}
                    <a href="{{ add_url }}" class="btn btn-primary btn-lg">{{ add_text|default:"Agregar" }}</a>
                {% else %}
                    <a href="{% url add_url %}" class="btn btn-primary btn-lg">{{ add_text|default:"Agregar" }}</a>
                {% endif %}
            {% endif %}
            <!-- Botones adicionales personalizados -->
            {% if additional_buttons %}
                {% for button in additional_buttons %}
                    <a href="{{ button.url }}"
                       class="{{ button.class|default:'btn btn-primary btn-lg' }}"
                       {% if button.id %}id="{{ button.id }}"{% endif %}
                       {% if button.title %}title="{{ button.title }}"{% endif %}>{{ button.label }}</a>
                {% endfor %}
            {% endif %}
            {% if not ajax_search_mode %}
                {% with form_id=filters_mode|yesno:"filters-form,simple-search-form" %}
                    <button type="submit" form="{{ form_id }}" class="btn btn-success btn-lg">Filtrar</button>
                {% endwith %}
            {% endif %}
        </div>
    </div>
</div>
{% if filters_mode %}
    <script src="{% static filters_js|default:'custom/js/advanced_filters.js' %}"></script>
{% elif ajax_search_mode %}
    <script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("ajax-search-input");
    const tbody = document.getElementById(
      '{{ target_tbody_id|default:"ajax-table-tbody" }}'
    );
    const loadingIndicator = document.getElementById("ajax-loading-indicator");
    const resultsCount = document.getElementById("ajax-results-count");
    const paginationContainer = document.getElementById("pagination-container");

    let searchTimeout;
    let currentRequest;
    let currentQuery = "";

    // Función para realizar la búsqueda
    function performSearch(query, page = 1) {
      currentQuery = query;

      // Cancelar request anterior si existe
      if (currentRequest) {
        currentRequest.abort();
      }

      // Mostrar indicador de carga
      if (loadingIndicator) {
        loadingIndicator.style.display = "block";
      }
      if (tbody) {
        tbody.style.opacity = "0.5";
      }

      // Construir URL con parámetros
      let url = `{{ ajax_url }}?busqueda=${encodeURIComponent(query)}`;
      if (page > 1) {
        url += `&page=${page}`;
      }

      // Realizar petición AJAX
      currentRequest = fetch(url, {
        method: "GET",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Error en la respuesta del servidor");
          }
          return response.json();
        })
        .then((data) => {
          // Actualizar tabla
          if (tbody) {
            tbody.innerHTML = data.html;
          }

          // Actualizar paginación
          if (paginationContainer && data.pagination_html) {
            paginationContainer.innerHTML = data.pagination_html;
            setupPaginationHandlers();
          }

          // Actualizar contador
          if (resultsCount) {
            if (query.trim()) {
              resultsCount.textContent = `${data.count} resultado(s) encontrado(s)`;
            } else {
              resultsCount.textContent = "";
            }
          }

          // Ocultar indicador de carga
          if (loadingIndicator) {
            loadingIndicator.style.display = "none";
          }
          if (tbody) {
            tbody.style.opacity = "1";
          }

          currentRequest = null;
        })
        .catch((error) => {
          if (error.name !== "AbortError") {
            console.error("Error en la búsqueda:", error);

            // Mostrar mensaje de error
            if (tbody) {
              tbody.innerHTML = `
                            <tr>
                                <td colspan="100%" class="text-center text-danger py-4">
                                    Error al cargar los datos. Intente nuevamente.
                                </td>
                            </tr>
                        `;
            }
          }

          // Ocultar indicador de carga
          if (loadingIndicator) {
            loadingIndicator.style.display = "none";
          }
          if (tbody) {
            tbody.style.opacity = "1";
          }

          currentRequest = null;
        });
    }

    // Función para configurar los manejadores de eventos de paginación
    function setupPaginationHandlers() {
      const paginationLinks = document.querySelectorAll(
        '#pagination-container a[href*="page="]'
      );

      paginationLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();

          // Extraer número de página del href
          const url = new URL(this.href);
          const page = url.searchParams.get("page") || 1;

          // Realizar búsqueda con la página específica
          performSearch(currentQuery, page);
        });
      });
    }

    // Event listener para el input de búsqueda
    if (searchInput) {
      searchInput.addEventListener("input", function () {
        const query = this.value.trim();

        // Limpiar timeout anterior
        clearTimeout(searchTimeout);

        // Establecer nuevo timeout para evitar demasiadas peticiones
        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300); // Esperar 300ms después de que el usuario deje de escribir
      });

      // Limpiar búsqueda al presionar Escape
      searchInput.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          this.value = "";
          currentQuery = "";
          performSearch("");
        }
      });

      // Realizar búsqueda inicial si hay valor en el input
      const initialValue = searchInput.value.trim();
      if (initialValue) {
        currentQuery = initialValue;
        performSearch(initialValue);
      }

      // Configurar manejadores de paginación inicial
      setupPaginationHandlers();
    }
  });
    </script>
{% endif %}
{% endwith %}
