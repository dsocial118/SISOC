{% extends "includes/main.html" %}
{% load static crispy_forms_tags %}

{% block title %}{{ titulo_pagina }}{% endblock %}
{% block titulo-pagina %}{{ titulo_pagina }}{% endblock %}

{% block content %}
    <div class="container mt-4">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Datos del Comunicado -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-newspaper"></i> Datos del Comunicado
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="id_titulo" class="form-label">Título <span class="text-danger">*</span></label>
                        {{ form.titulo }}
                        {% if form.titulo.errors %}
                            <div class="invalid-feedback d-block">{{ form.titulo.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="id_cuerpo" class="form-label">Contenido <span class="text-danger">*</span></label>
                        {{ form.cuerpo }}
                        {% if form.cuerpo.errors %}
                            <div class="invalid-feedback d-block">{{ form.cuerpo.errors.0 }}</div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Escribe el contenido del comunicado en texto plano.
                        </small>
                    </div>

                    <!-- Tipo de Comunicado -->
                    <div class="mb-3">
                        <label for="id_tipo" class="form-label">Tipo de Comunicado <span class="text-danger">*</span></label>
                        {{ form.tipo }}
                        {% if form.tipo.errors %}
                            <div class="invalid-feedback d-block">{{ form.tipo.errors.0 }}</div>
                        {% endif %}
                        <small class="form-text text-muted">
                            <strong>Interno:</strong> Visible en SISOC para usuarios del sistema.
                            <strong>Comedores:</strong> Visible en la app móvil para los comedores seleccionados.
                        </small>
                    </div>

                    <!-- Opciones para Comunicados a Comedores -->
                    <div id="comedores-options" class="{% if form.instance.tipo != 'externo' and not es_tecnico %}d-none{% endif %}">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6><i class="fas fa-utensils"></i> Destinatarios</h6>

                                <div class="mb-3">
                                    <div class="form-check form-switch" style="display: flex; align-items: center;">
                                        {{ form.para_todos_comedores }}
                                        <label class="form-check-label" for="id_para_todos_comedores" style="margin-bottom: 0;">
                                            Enviar a todos los comedores
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">
                                        Si activa esta opción, el comunicado se enviará a todos los comedores que tiene asignados.
                                    </small>
                                </div>

                                <div id="comedores-selector" class="{% if form.instance.para_todos_comedores %}d-none{% endif %}">
                                    <label for="id_comedores" class="form-label">Seleccionar Comedores</label>
                                    {{ form.comedores }}
                                    {% if form.comedores.errors %}
                                        <div class="invalid-feedback d-block">{{ form.comedores.errors.0 }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Mantenga Ctrl presionado para seleccionar múltiples comedores.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_fecha_vencimiento" class="form-label">Fecha de Vencimiento (opcional)</label>
                                {{ form.fecha_vencimiento }}
                                {% if form.fecha_vencimiento.errors %}
                                    <div class="invalid-feedback d-block">{{ form.fecha_vencimiento.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Si se establece, el comunicado dejará de mostrarse después de esta fecha.
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Destacado - Solo para comunicados internos -->
                            <div id="destacado-option" class="mb-3 {% if form.instance.tipo == 'externo' or es_tecnico %}d-none{% endif %}">
                                <div class="form-check form-switch mt-4" style="display: flex; align-items: center;">
                                    {{ form.destacado }}
                                    <label class="form-check-label" for="id_destacado" style="margin-bottom: 0;">
                                        <i class="fas fa-star text-warning"></i> Marcar como Destacado
                                    </label>
                                </div>
                                <small class="form-text text-muted">
                                    Los comunicados destacados aparecen fijados arriba de la lista.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Archivos Adjuntos -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-paperclip"></i> Archivos Adjuntos
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Campo para subir múltiples archivos -->
                    <div class="mb-3">
                        <label class="form-label">Subir archivos</label>
                        <input type="file" name="archivos_adjuntos" id="archivosInput" class="d-none" multiple>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" id="addFilesBtn" class="btn btn-outline-primary">
                                <i class="fas fa-plus"></i> Agregar archivos
                            </button>
                            <div id="selectedFilesInfo" class="d-none">
                                <span class="badge bg-info"><span id="fileCount">0</span> archivo(s) seleccionado(s)</span>
                            </div>
                        </div>
                        <small class="form-text text-muted d-block mt-2">
                            Puedes agregar múltiples archivos haciendo clic varias veces en el botón.
                        </small>
                    </div>

                    <!-- Contenedor para vista previa de archivos -->
                    <div id="filePreviewContainer" class="mt-3"></div>

                    <!-- Management form del formset (siempre necesario) -->
                    {% if adjuntos_formset %}
                        {{ adjuntos_formset.management_form }}
                    {% endif %}

                    <!-- Archivos existentes (solo en edición) -->
                    {% if is_edit and adjuntos_formset.forms %}
                        <hr>
                        <h6 class="mb-3">Archivos actuales</h6>
                        <div id="adjuntos-container">
                            {% for adjunto_form in adjuntos_formset %}
                                {% if adjunto_form.instance.pk %}
                                    <div class="adjunto-row mb-2 p-2 border rounded bg-light d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-file me-2"></i>
                                            <a href="{{ adjunto_form.instance.archivo.url }}" target="_blank">
                                                {{ adjunto_form.instance.nombre_original }}
                                            </a>
                                            {% for hidden in adjunto_form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        </div>
                                        <div class="form-check">
                                            {{ adjunto_form.DELETE }}
                                            <label class="form-check-label text-danger" for="{{ adjunto_form.DELETE.id_for_label }}">
                                                Eliminar
                                            </label>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Estado actual (solo en edición) -->
            {% if is_edit and object %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> Información del Comunicado
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Estado:</strong>
                                {% if object.estado == 'borrador' %}
                                    <span class="badge bg-secondary">Borrador</span>
                                {% elif object.estado == 'publicado' %}
                                    <span class="badge bg-success">Publicado</span>
                                {% elif object.estado == 'archivado' %}
                                    <span class="badge bg-dark">Archivado</span>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <strong>Creado:</strong>
                                {{ object.fecha_creacion|date:"d/m/Y H:i" }}
                            </div>
                            <div class="col-md-4">
                                <strong>Creador:</strong>
                                {{ object.usuario_creador.get_full_name|default:object.usuario_creador.username }}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Botones -->
            <div class="d-flex justify-content-between">
                <a href="{% url 'comunicados_gestion' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Guardar Comunicado
                </button>
            </div>
        </form>
    </div>

    <script>
    (function() {
        // Tipo de comunicado - mostrar/ocultar campos
        const tipoSelect = document.getElementById("id_tipo");
        const comedoresOptions = document.getElementById("comedores-options");
        const destacadoOption = document.getElementById("destacado-option");
        const paraTodosCheckbox = document.getElementById("id_para_todos_comedores");
        const comedoresSelector = document.getElementById("comedores-selector");

        function updateFieldsVisibility() {
            if (!tipoSelect) return;
            const isExterno = tipoSelect.value === "externo";
            if (comedoresOptions) {
                comedoresOptions.classList.toggle("d-none", !isExterno);
            }
            if (destacadoOption) {
                destacadoOption.classList.toggle("d-none", isExterno);
            }
        }

        function updateComedoresSelector() {
            if (!paraTodosCheckbox || !comedoresSelector) return;
            comedoresSelector.classList.toggle("d-none", paraTodosCheckbox.checked);
        }

        if (tipoSelect) {
            tipoSelect.addEventListener("change", updateFieldsVisibility);
            updateFieldsVisibility();
        }

        if (paraTodosCheckbox) {
            paraTodosCheckbox.addEventListener("change", updateComedoresSelector);
            updateComedoresSelector();
        }

        // Manejo de archivos adjuntos
        let selectedFiles = [];
        const addFilesBtn = document.getElementById("addFilesBtn");
        const archivosInput = document.getElementById("archivosInput");
        const selectedFilesInfo = document.getElementById("selectedFilesInfo");
        const fileCount = document.getElementById("fileCount");
        const filePreviewContainer = document.getElementById("filePreviewContainer");

        if (addFilesBtn && archivosInput) {
            addFilesBtn.addEventListener("click", function () {
                archivosInput.click();
            });

            archivosInput.addEventListener("change", function () {
                const files = Array.from(this.files);
                selectedFiles = selectedFiles.concat(files);
                updateFileDisplay();
            });

            function updateFileDisplay() {
                if (selectedFiles.length > 0) {
                    if (selectedFilesInfo) selectedFilesInfo.classList.remove("d-none");
                    if (fileCount) fileCount.textContent = selectedFiles.length;
                } else {
                    if (selectedFilesInfo) selectedFilesInfo.classList.add("d-none");
                }

                if (filePreviewContainer) {
                    filePreviewContainer.innerHTML = "";
                    selectedFiles.forEach(function(file, index) {
                        const previewDiv = document.createElement("div");
                        previewDiv.className = "archivo-preview-item d-flex align-items-center justify-content-between p-2 mb-2 border rounded";
                        previewDiv.setAttribute("data-index", index);

                        let iconClass = "fas fa-file";
                        if (file.type.startsWith("image/")) {
                            iconClass = "fas fa-file-image text-primary";
                        } else if (file.type.includes("pdf")) {
                            iconClass = "fas fa-file-pdf text-danger";
                        } else if (file.type.includes("word") || file.name.endsWith(".doc") || file.name.endsWith(".docx")) {
                            iconClass = "fas fa-file-word text-primary";
                        } else if (file.type.includes("excel") || file.name.endsWith(".xls") || file.name.endsWith(".xlsx")) {
                            iconClass = "fas fa-file-excel text-success";
                        }

                        const sizeStr = formatFileSize(file.size);
                        previewDiv.innerHTML =
                            '<div class="d-flex align-items-center">' +
                                '<i class="' + iconClass + ' me-2"></i>' +
                                '<div>' +
                                    '<div class="fw-bold small">' + file.name + '</div>' +
                                    '<div class="text-muted small">' + sizeStr + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<button type="button" class="btn btn-sm btn-outline-danger btn-remove-file" data-index="' + index + '" title="Eliminar">' +
                                '<i class="fas fa-times"></i>' +
                            '</button>';

                        filePreviewContainer.appendChild(previewDiv);
                    });

                    filePreviewContainer.querySelectorAll(".btn-remove-file").forEach(function(btn) {
                        btn.addEventListener("click", function() {
                            const idx = parseInt(this.getAttribute("data-index"));
                            selectedFiles.splice(idx, 1);
                            updateFileDisplay();
                        });
                    });
                }
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return "0 Bytes";
                const k = 1024;
                const sizes = ["Bytes", "KB", "MB", "GB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
            }

            const comunicadoForm = document.querySelector('form[enctype="multipart/form-data"]');
            if (comunicadoForm) {
                comunicadoForm.addEventListener("submit", function (e) {
                    if (selectedFiles.length > 0) {
                        e.preventDefault();
                        e.stopPropagation();

                        const formData = new FormData(comunicadoForm);
                        formData.delete("archivos_adjuntos");

                        selectedFiles.forEach(function(file) {
                            formData.append("archivos_adjuntos", file);
                        });

                        fetch(comunicadoForm.action || window.location.href, {
                            method: "POST",
                            body: formData
                        })
                        .then(function(response) {
                            if (response.redirected) {
                                window.location.href = response.url;
                            } else if (response.ok) {
                                if (response.url && response.url.includes("/gestion")) {
                                    window.location.href = response.url;
                                } else {
                                    window.location.reload();
                                }
                            } else {
                                alert("Error al guardar el comunicado");
                            }
                        })
                        .catch(function() {
                            alert("Error al enviar el formulario");
                        });

                        return false;
                    }
                }, true);
            }
        }
    })();
    </script>
{% endblock %}
