{% extends "includes/main.html" %}
{% load crispy_forms_tags %}
{% block title %}Agregar Intervención{% endblock %}
{% block content %}
    <style>
        /* ESTILOS PERSONALIZADOS PARA SELECT2 - TEMA OSCURO */
        .select2-container--default .select2-selection--single {
            height: 38px;
            background-color: #1e2a3a !important;
            border: 1px solid #3d4f63 !important;
            border-radius: 0.25rem;
        }

        .select2-container--default.select2-container--focus .select2-selection--single {
            background-color: #253446 !important;
            border-color: #f39c12 !important;
            box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.15) !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
            color: #e5e7eb !important;
            background-color: transparent !important;
            padding-left: 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: #9ca3af transparent transparent transparent;
        }

        .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
            border-color: transparent transparent #9ca3af transparent;
        }

        .select2-container {
            width: 100% !important;
        }

        .select2-dropdown {
            background-color: #1e2a3a !important;
            border: 1px solid #3d4f63;
            z-index: 1045 !important;
            max-width: 100vw !important;
            box-sizing: border-box !important;
        }

        .select2-search--dropdown .select2-search__field {
            background-color: #253446 !important;
            border: 1px solid #3d4f63 !important;
            border-radius: 0.25rem;
            color: #e5e7eb !important;
        }

        .select2-results__option {
            background-color: #1e2a3a !important;
            color: #e5e7eb !important;
            padding: 8px 12px !important;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #f39c12 !important;
            color: #1e2a3a !important;
            font-weight: 500;
        }

        .select2-container--default .select2-results__option[aria-selected=true] {
            background-color: #2c3e50 !important;
            color: #f39c12 !important;
            font-weight: 500;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected=true] {
            background-color: #f39c12 !important;
            color: #1e2a3a !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: #9ca3af !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__clear {
            color: #9ca3af !important;
            margin-right: 10px;
        }

        /* Estilos para Select2 inválido */
        .select2-container.is-invalid .select2-selection,
        .select2-container.is-invalid .select2-selection--single {
            border-color: #dc3545 !important;
        }

        /* Prevenir overflow horizontal cuando Select2 está abierto */
        body.select2-container--open {
            overflow-x: hidden !important;
        }

        .select2-container--default .select2-dropdown {
            max-width: calc(100vw - 40px) !important;
        }
    </style>
    <div class="row">
        <div class="col">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Paso 1 -->
                <div id="step-1">
                    <h3>Paso 1 - Datos Iniciales</h3>
                    <div class="form-group">{{ form.tipo_intervencion|as_crispy_field }}</div>
                    <div class="form-group">{{ form.subintervencion|as_crispy_field }}</div>
                    <div class="form-group">{{ form.destinatario|as_crispy_field }}</div>
                    <button type="button" id="next-step" class="btn btn-primary">Siguiente</button>
                </div>
                <!-- Paso 2 -->
                <div id="step-2" class="d-none">
                    <h3>Paso 2 - Datos de Contacto</h3>
                    <div class="form-group">
                        {{ form.fecha|as_crispy_field }}
                        <div id="fecha-error" class="invalid-feedback" style="display: none;"></div>
                    </div>
                    <div class="form-group">{{ form.forma_contacto|as_crispy_field }}</div>
                    <div class="form-group">{{ form.observaciones|as_crispy_field }}</div>
                    <div class="form-group">{{ form.tiene_documentacion|as_crispy_field }}</div>
                    <div class="form-group d-none" id="documentacion-field">
                        <label for="documentacion"></label>
                        {{ form.documentacion|as_crispy_field }}
                    </div>
                    <button type="button" id="prev-step" class="btn btn-secondary">Anterior</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const nextStep = document.getElementById("next-step");
        const prevStep = document.getElementById("prev-step");
        const step1 = document.getElementById("step-1");
        const step2 = document.getElementById("step-2");
        const tieneDocumentacion = document.getElementById("id_tiene_documentacion");
        const documentacionField = document.getElementById("documentacion-field");
        const tipoIntervencionSelect = document.getElementById("id_tipo_intervencion");
        const subIntervencionSelect = document.getElementById("id_subintervencion");
        const fechaInput = document.getElementById("id_fecha");
        const fechaError = document.getElementById("fecha-error");

        // ============================================
        // FUNCIONES DE AUTO FOCUS PARA SELECT2
        // ============================================
        function focusSelect2SearchField() {
            attemptFocus();
            setTimeout(attemptFocus, 10);
            setTimeout(attemptFocus, 50);
        }

        function attemptFocus() {
            const searchFields = document.querySelectorAll('.select2-search__field');
            for (let field of searchFields) {
                const isVisible = field.offsetParent !== null &&
                                 window.getComputedStyle(field).display !== 'none' &&
                                 window.getComputedStyle(field).visibility !== 'hidden';
                if (isVisible) {
                    field.focus();
                    return;
                }
            }
        }

        // ============================================
        // INICIALIZAR SELECT2 EN TIPO DE INTERVENCIÓN
        // ============================================
        function initializeSelect2Fields() {
            if (typeof jQuery === 'undefined' || typeof jQuery.fn.select2 === 'undefined') {
                return;
            }

            // Verificar que los elementos existan
            const $tipoIntervencion = jQuery('#id_tipo_intervencion');
            const $subIntervencion = jQuery('#id_subintervencion');

            if ($tipoIntervencion.length === 0) {
                return;
            }

            // Inicializar Select2 en tipo de intervención
            $tipoIntervencion.select2({
                placeholder: "Seleccione un tipo de intervención",
                allowClear: true,
                width: '100%'
            });

            // Inicializar Select2 en subintervención
            $subIntervencion.select2({
                placeholder: "Seleccione una subintervención",
                allowClear: true,
                width: '100%'
            });

            // ============================================
            // AUTO FOCUS EN SELECT2 SEARCH
            // ============================================
            jQuery(document).on('select2:open', function() {
                document.body.classList.add('select2-container--open');
                focusSelect2SearchField();
            });

            jQuery(document).on('select2:close', function() {
                document.body.classList.remove('select2-container--open');
            });

            // Observer para detectar nuevos dropdowns
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.classList) {
                            if (node.classList.contains('select2-container--open') ||
                                node.classList.contains('select2-dropdown')) {
                                focusSelect2SearchField();
                            }
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Llamar a la inicialización después de un pequeño delay
        setTimeout(initializeSelect2Fields, 100);

        // Configurar atributos min y max para el campo fecha
        if (fechaInput) {
            fechaInput.setAttribute("min", "2000-01-01");
            fechaInput.setAttribute("max", "2100-12-31");
        }

        // Función para validar el año de la fecha
        function validarFecha() {
            if (!fechaInput.value) {
                return true; // Si está vacío, dejamos que la validación required lo maneje
            }

            const fechaSeleccionada = new Date(fechaInput.value);
            const año = fechaSeleccionada.getFullYear();

            if (año < 2000) {
                fechaInput.classList.add("is-invalid");
                fechaError.textContent = "El año de la fecha debe ser mayor o igual a 2000.";
                fechaError.style.display = "block";
                return false;
            } else if (año > 2100) {
                fechaInput.classList.add("is-invalid");
                fechaError.textContent = "El año de la fecha debe ser menor o igual a 2100.";
                fechaError.style.display = "block";
                return false;
            } else {
                fechaInput.classList.remove("is-invalid");
                fechaError.style.display = "none";
                return true;
            }
        }

        // Validar fecha al cambiar
        if (fechaInput) {
            fechaInput.addEventListener("change", validarFecha);
            fechaInput.addEventListener("blur", validarFecha);
        }

        nextStep.addEventListener("click", function () {
            let formStep1 = Array.from(step1.querySelectorAll("select[required]"));
            const isValid = formStep1.every(input => {
                if (input.tagName === "SELECT") {
                    return input.value !== "";
                }
                return input.checkValidity();
            });

            if (isValid) {
                step1.classList.add("d-none");
                step2.classList.remove("d-none");
            } else {
                formStep1.forEach(input => {
                    if (input.tagName === "SELECT") {
                        if (input.value === "") {
                            input.classList.add("is-invalid");
                            // Si es Select2, también marcar el contenedor
                            if (typeof jQuery !== 'undefined' && jQuery(input).data('select2')) {
                                jQuery(input).next('.select2-container').addClass('is-invalid');
                            }
                        } else {
                            input.classList.remove("is-invalid");
                            // Si es Select2, también limpiar el contenedor
                            if (typeof jQuery !== 'undefined' && jQuery(input).data('select2')) {
                                jQuery(input).next('.select2-container').removeClass('is-invalid');
                            }
                        }
                    } else {
                        if (!input.checkValidity()) {
                            input.classList.add("is-invalid");
                        } else {
                            input.classList.remove("is-invalid");
                        }
                    }
                });
            }
        });

        prevStep.addEventListener("click", function () {
            step2.classList.add("d-none");
            step1.classList.remove("d-none");
        });

        tieneDocumentacion.addEventListener("change", function () {
            if (tieneDocumentacion.checked) {
                documentacionField.classList.remove("d-none");
            } else {
                documentacionField.classList.add("d-none");
            }
        });

        // ============================================
        // CARGAR SUBINTERVENCIONES DINÁMICAMENTE
        // ============================================
        function cargarTipoIntervencion(tipoIntervencionId) {
            // Limpiar opciones actuales
            subIntervencionSelect.innerHTML = '<option value="">Seleccione una opción</option>';
            subIntervencionSelect.removeAttribute("required");

            // Si Select2 está disponible, destruirlo antes de modificar
            if (typeof jQuery !== 'undefined' && jQuery.fn.select2 !== 'undefined') {
                const $subSelect = jQuery('#id_subintervencion');
                if ($subSelect.data('select2')) {
                    $subSelect.select2('destroy');
                }
            }

            if (tipoIntervencionId) {
                fetch(`/comedores/ajax/load-subestadosintervenciones/?id=${tipoIntervencionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            data.forEach(subIntervencion => {
                                const option = document.createElement("option");
                                option.value = subIntervencion.id;
                                option.textContent = subIntervencion.text;
                                subIntervencionSelect.appendChild(option);
                            });
                        }

                        // Reinicializar Select2 después de cargar opciones
                        if (typeof jQuery !== 'undefined' && jQuery.fn.select2 !== 'undefined') {
                            jQuery('#id_subintervencion').select2({
                                placeholder: "Seleccione una subintervención",
                                allowClear: true,
                                width: '100%'
                            });
                        }
                    })
                    .catch(error => console.error("Error al cargar subintervenciones:", error));
            } else {
                // Reinicializar Select2 aunque no haya datos
                if (typeof jQuery !== 'undefined' && jQuery.fn.select2 !== 'undefined') {
                    jQuery('#id_subintervencion').select2({
                        placeholder: "Seleccione una subintervención",
                        allowClear: true,
                        width: '100%'
                    });
                }
            }
        }

        // Registrar evento de cambio
        if (typeof jQuery !== 'undefined' && typeof jQuery.fn.select2 !== 'undefined') {
            // Usar evento de Select2
            jQuery('#id_tipo_intervencion').on('select2:select select2:clear', function (e) {
                const value = e.params && e.params.data ? e.params.data.id : '';
                cargarTipoIntervencion(value);
            });
        } else {
            // Fallback a evento nativo
            tipoIntervencionSelect.addEventListener("change", function () {
                cargarTipoIntervencion(this.value);
            });
        }

        // Cargar subintervenciones iniciales si hay un valor preseleccionado
        if (tipoIntervencionSelect.value) {
            cargarTipoIntervencion(tipoIntervencionSelect.value);
        }

        // Validar fecha antes de enviar el formulario
        const form = document.querySelector("form");
        if (form) {
            form.addEventListener("submit", function (event) {
                if (!validarFecha()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            });
        }
    });
    </script>
{% endblock %}
