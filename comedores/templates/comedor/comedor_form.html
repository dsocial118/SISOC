{% extends "includes/main.html" %}
{% load static crispy_forms_tags %}
;
{% block title %}Comedores{% endblock %}
{% block titulo-pagina %}Comedores{% endblock %}
{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right px-3">
        <li class="breadcrumb-item">
            <a href="{% url 'comedores' %}">Comedores</a>
        </li>
        {% if request.resolver_match.url_name == "comedor_editar" %}
            <li class="breadcrumb-item">
                <a href="{% url 'comedor_detalle' comedor.id %}">{{ comedor.nombre }}</a>
            </li>
            <li class="breadcrumb-item active">Editar</li>
        {% else %}
            <li class="breadcrumb-item active">Agregar</li>
        {% endif %}
    </ol>
{% endblock %}
;
{% block content %}
    <link rel="stylesheet"
          href="{% static 'custom/css/comedorRelevamiento.css' %}" />
    <div class="d-flex justify-content-between mb-3">
        <div>
            {% if comedor.id %}
                <a href="{% url 'comedor_detalle' comedor.id %}"
                   class='btn btn-secondary'>Volver</a>
            {% else %}
                <a href="{% url 'comedores' %}" class='btn btn-secondary'>Volver</a>
            {% endif %}
        </div>
        <div>
            <a class='btn btn-secondary print mr-1 d-none d-sm-inline'>Imprimir</a>
            <a href='#' onclick='window.history.back();' class='btn btn-secondary'>Cancelar</a>
        </div>
    </div>
    <div class="row comedor-form">
        <div class="col-12">
            <form method="post"
                  id="comedorForm"
                  class="w-100"
                  enctype="multipart/form-data"
                  onsubmit="return confirmSubmit()">
                <div class="card card-primary card-outline">
                    <div class="bs-stepper">
                        <div class="card-header mb-3">
                            <h3 class="card-title">Agregar Comedor/Merendero</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row justify-content-center">
                                {% csrf_token %}
                                <div class="form-group row">
                                    <div class="col-2">{{ form.nombre|as_crispy_field }}</div>
                                    <div class="col-2">{{ form.id_externo|as_crispy_field }}</div>
                                    <div class="col-2">{{ form.tipocomedor|as_crispy_field }}</div>
                                    <div class="col-3">{{ form.organizacion|as_crispy_field }}</div>
                                    <div class="col-3">{{ form.programa|as_crispy_field }}</div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-2">{{ form.codigo_de_proyecto|as_crispy_field }}</div>
                                    <div class="col-1">{{ form.comienzo|as_crispy_field }}</div>
                                    <div class="col-3">{{ form.provincia|as_crispy_field }}</div>
                                    <div class="col-3">{{ form.municipio|as_crispy_field }}</div>
                                    <div class="col-3">{{ form.localidad|as_crispy_field }}</div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-4">{{ form.partido|as_crispy_field }}</div>
                                    <div class="col-4">{{ form.barrio|as_crispy_field }}</div>
                                    <div class="col-4">{{ form.codigo_postal|as_crispy_field }}</div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-2">{{ form.calle|as_crispy_field }}</div>
                                    <div class="col-2">{{ form.numero|as_crispy_field }}</div>
                                    <div class="col-2">{{ form.piso|as_crispy_field }}</div>
                                    <div class="col-2">{{ form.departamento|as_crispy_field }}</div>
                                    <div class="col-2">{{ form.manzana|as_crispy_field }}</div>
                                    <div class="col-2">{{ form.lote|as_crispy_field }}</div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-3">{{ form.entre_calle_1|as_crispy_field }}</div>
                                    <div class="col-3">{{ form.entre_calle_2|as_crispy_field }}</div>
                                    <div class="col-3">{{ form.latitud|as_crispy_field }}</div>
                                    <div class="col-3">{{ form.longitud|as_crispy_field }}</div>
                                </div>
                                <div class="form-group row">
                                    <div>{{ form.foto_legajo|as_crispy_field }}</div>
                                    <div id="fotoLegajoPreviewContainer" class="mt-3 col-12">
                                        {% if comedor.foto_legajo %}
                                            <div class="col-md-3 col-sm-4 col-6">
                                                <div class="card position-relative">
                                                    <!-- Checkbox para eliminar foto del legajo -->
                                                    <div class="position-absolute" style="top: 5px; right: 5px; z-index: 10; background: rgba(255,255,255,0.8); border-radius: 3px; padding: 2px;">
                                                        <div class="form-check">
                                                            <input type="checkbox"
                                                                   name="foto_legajo_borrar"
                                                                   id="foto_legajo_borrar"
                                                                   class="form-check-input"
                                                                   style="transform: scale(1.2);" />
                                                            <label class="form-check-label visually-hidden" 
                                                                   for="foto_legajo_borrar">
                                                                Eliminar foto legajo
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="card-header">
                                                        <h5 class="card-title mb-0">Foto Legajo Actual</h5>
                                                    </div>
                                                    <!-- Imagen -->
                                                    <div class="position-relative overflow-hidden" style="height: 120px;">
                                                        <img src="/media/{{ comedor.foto_legajo }}"
                                                             alt="Foto Legajo"
                                                             class="card-img-top w-100 h-100" 
                                                             style="object-fit: cover; height: 120px;" />
                                                    </div>
                                                    <!-- Información del archivo -->
                                                    <div class="card-body p-2">
                                                        <small class="text-muted text-truncate d-block" 
                                                               title="{{ comedor.foto_legajo }}">
                                                            {% with comedor.foto_legajo as img_path %}
                                                                {{ img_path|slice:"comedor/"|default:img_path }}
                                                            {% endwith %}
                                                        </small>
                                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                                            <small class="text-success"><i class="fas fa-check-circle"></i> Guardada</small>
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-danger p-1" 
                                                                    onclick="toggleFotoLegajoDeletion()"
                                                                    title="Marcar para eliminar"
                                                                    style="font-size: 12px;">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card card-primary card-outline">
                    <div class="bs-stepper">
                        <div class="card-header mb-3">
                            <h3 class="card-title">Datos del referente del comedor/merendero</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group row">
                                <div class="col-4">{{ referente_form.nombre|as_crispy_field }}</div>
                                <div class="col-4">{{ referente_form.apellido|as_crispy_field }}</div>
                                <div class="col-4">{{ referente_form.mail|as_crispy_field }}</div>
                            </div>
                            <div class="form-group row">
                                <div class="col-4">{{ referente_form.celular|as_crispy_field }}</div>
                                <div class="col-4">{{ referente_form.documento|as_crispy_field }}</div>
                                <div class="col-4">{{ referente_form.funcion|as_crispy_field }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card card-primary card-outline">
                    <div class="bs-stepper">
                        <div class="card-header mb-3">
                            <h3 class="card-title">Imágenes</h3>
                        </div>
                        <div class="card-body">
                            {% if imagenes_borrar %}
                                <div class="mb-4">
                                    <h6 class="text-muted mb-3">Imágenes Existentes:</h6>
                                    <div class="row">
                                        {% for imagen in imagenes_borrar %}
                                            <div class="col-md-3 col-sm-4 col-6 mb-3">
                                                <div class="card position-relative">
                                                    <!-- Checkbox para eliminar en la esquina superior derecha -->
                                                    <div class="position-absolute" style="top: 5px; right: 5px; z-index: 10; background: rgba(255,255,255,0.8); border-radius: 3px; padding: 2px;">
                                                        <div class="form-check">
                                                            <input type="checkbox"
                                                                   name="imagen_ciudadano-borrar-{{ imagen.id }}"
                                                                   id="imagen_ciudadano-borrar-{{ imagen.id }}"
                                                                   class="form-check-input"
                                                                   style="transform: scale(1.2);" />
                                                            <label class="form-check-label visually-hidden" 
                                                                   for="imagen_ciudadano-borrar-{{ imagen.id }}">
                                                                Eliminar
                                                            </label>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Imagen -->
                                                    <div class="position-relative overflow-hidden" style="height: 120px;">
                                                        <img src="/media/{{ imagen.imagen }}"
                                                             alt="Comedor"
                                                             class="card-img-top w-100 h-100"
                                                             style="object-fit: cover; height: 120px;" />
                                                    </div>
                                                    
                                                    <!-- Información del archivo -->
                                                    <div class="card-body p-2">
                                                        <small class="text-muted text-truncate d-block" 
                                                               title="{{ imagen.imagen }}">
                                                            {% with imagen.imagen as img_path %}
                                                                {{ img_path|slice:"comedor/"|default:img_path }}
                                                            {% endwith %}
                                                        </small>
                                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                                            <small class="text-success"><i class="fas fa-check-circle"></i> Guardada</small>
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-danger p-1" 
                                                                    onclick="toggleImageDeletion('{{ imagen.id }}')"
                                                                    title="Marcar para eliminar"
                                                                    style="font-size: 12px;">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <hr class="my-4">
                                </div>
                            {% endif %}
                            <div class="form-group">
                                <h6 class="text-muted mb-3">Agregar Nuevas Imágenes:</h6>
                                <input type="file"
                                       name="imagenes"
                                       id="imagenesInput"
                                       class="d-none"
                                       multiple
                                       accept="image/*" />
                                
                                <button type="button" id="addImagesBtn" class="btn btn-primary mb-3">
                                    <i class="fas fa-plus"></i> Seleccionar Imágenes
                                </button>
                                
                                <!-- Contenedor para mostrar las imágenes seleccionadas -->
                                <div id="selectedImagesInfo" class="mb-2 d-none">
                                    <small class="text-muted">
                                        <span id="imageCount">0</span> imagen(es) seleccionada(s)
                                    </small>
                                </div>
                            </div>
                            <div id="imagePreviewContainer" class="mt-3 row"></div>
                            <div class="d-flex justify-content-end">
                                <div class="card-tools d-flex align-items-start my-3">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-success mx-1" type="submit">Guardar comedor</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
{% block customJS %}
    <script>
        var ajaxLoadMunicipiosUrl = "{% url 'ajax_load_municipios' %}";
        var ajaxLoadLocalidadesUrl = "{% url 'ajax_load_localidades' %}";
    </script>
    <script src="{% static 'custom/js/comedorform.js' %}"></script>
{% endblock %}
