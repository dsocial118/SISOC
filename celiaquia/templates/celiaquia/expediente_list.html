{% extends "includes/main.html" %}
{% load static custom_filters %}
{% block title %}Expedientes Celiaquía{% endblock %}
{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item">
            <a href="{% url 'expediente_list' %}">Expedientes</a>
        </li>
        <li class="breadcrumb-item active">Listar</li>
    </ol>
{% endblock %}
{% block content %}
    <!-- Estilos modernos reutilizables para listados -->
    <link rel="stylesheet" href="{% static 'custom/css/listModerno.css' %}" />
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3">
            {% if request.user|has_group:"CoordinadorCeliaquia" %}
                Bandeja de Subsecretaría
            {% elif request.user|has_group:"TecnicoCeliaquia" %}
                Mis Expedientes Asignados
            {% else %}
                Mis Expedientes
            {% endif %}
        </h2>
        {% if request.user|has_group:"ProvinciaCeliaquia" %}
            <a href="{% url 'expediente_create' %}" class="btn btn-primary">
                <i class="fa fa-plus-circle me-1"></i> Nuevo Expediente
            </a>
        {% endif %}
    </div>
    <div id="list-alerts"></div>
    <form method="get" class="mb-3">
        <div class="input-group input-group-lg">
            <input type="search"
                   name="q"
                   value="{{ request.GET.q }}"
                   class="form-control form-control-lg"
                   placeholder="Buscar por ID, número, estado, provincia o técnico…" />
            <button class="btn btn-lg btn-outline-secondary" type="submit">
                <i class="fa fa-search"></i>
            </button>
        </div>
    </form>
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover table-striped projects mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="sortable" data-column="id">
                            ID
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="numero">
                            Número de Expediente
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="fecha">
                            Fecha creación
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="provincia">
                            Provincia
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="estado">
                            Estado
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        {% if request.user|has_group:"CoordinadorCeliaquia" or request.user|has_group:"TecnicoCeliaquia" %}
                            <th>Técnico</th>
                        {% endif %}
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exp in expedientes %}
                        <tr data-exp-id="{{ exp.pk }}">
                            <td data-id="{{ exp.pk }}">{{ exp.pk }}</td>
                            <td data-numero="{{ exp.numero_expediente|default:'-' }}">{{ exp.numero_expediente|default:"-" }}</td>
                            <td data-fecha="{{ exp.fecha_creacion|date:'Y-m-d H:i' }}">{{ exp.fecha_creacion|date:"d/m/Y H:i" }}</td>
                            <td data-provincia="{{ exp.provincia }}">{{ exp.provincia }}</td>
                            <td data-estado="{{ exp.estado.display_name }}">
                                <span class="badge {% if exp.estado.nombre == 'CREADO' %}bg-secondary {% elif exp.estado.nombre == 'EN_ESPERA' %}bg-info {% elif exp.estado.nombre == 'CONFIRMACION_DE_ENVIO' %}bg-warning {% elif exp.estado.nombre == 'RECEPCIONADO' %}bg-secondary {% elif exp.estado.nombre == 'ASIGNADO' %}bg-primary {% elif exp.estado.nombre == 'PROCESO_DE_CRUCE' %}bg-dark {% elif exp.estado.nombre == 'CRUCE_FINALIZADO' %}bg-success {% else %}bg-body-tertiary text-body{% endif %}">
                                    {{ exp.estado.display_name }}
                                </span>
                                {% if exp.legajos_subsanar_count > 0 %}
                                    <div class="mt-1">
                                        <span class="badge bg-warning text-dark">
                                            <i class="fa fa-exclamation-triangle"></i> {{ exp.legajos_subsanar_count }} a subsanar
                                        </span>
                                    </div>
                                {% endif %}
                            </td>
                            {% if request.user|has_group:"CoordinadorCeliaquia" or request.user|has_group:"TecnicoCeliaquia" %}
                                <td>
                                    {% if request.user|has_group:"CoordinadorCeliaquia" %}
                                        <!-- SOLO mostrar selector cuando el estado ya es RECEPCIONADO o ASIGNADO -->
                                        {% if exp.estado.nombre == 'RECEPCIONADO' or exp.estado.nombre == 'ASIGNADO' %}
                                            <div>
                                                <select class="form-select form-select-sm js-tecnico"
                                                        style="min-width: 200px">
                                                    <option value="">— Agregar técnico —</option>
                                                    {% for t in tecnicos %}<option value="{{ t.id }}">{{ t.get_full_name|default:t.username }}</option>{% endfor %}
                                                </select>
                                                <!-- Badges de técnicos asignados -->
                                                {% if exp.asignaciones_tecnicos.all %}
                                                    <div class="mt-2">
                                                        {% for asignacion in exp.asignaciones_tecnicos.all %}
                                                            <span class="badge bg-primary me-1 mb-1">
                                                                {{ asignacion.tecnico.get_full_name|default:asignacion.tecnico.username }}
                                                                <button type="button"
                                                                        class="btn-close btn-close-white ms-1 js-remove-tecnico"
                                                                        data-tecnico-id="{{ asignacion.tecnico.id }}"
                                                                        data-exp-id="{{ exp.pk }}"
                                                                        style="font-size: 0.7em"></button>
                                                            </span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    {% else %}
                                        {% if exp.asignaciones_tecnicos.all %}
                                            {% for asignacion in exp.asignaciones_tecnicos.all %}
                                                <span class="badge bg-primary me-1">{{ asignacion.tecnico.get_full_name|default:asignacion.tecnico.username }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            {% endif %}
                            <td class="text-end">
                                <a href="{% url 'expediente_detail' exp.pk %}"
                                   class="btn btn-primary"
                                   title="Ver detalle del expediente">
                                    <i class="fas fa-eye"></i>
                                    Ver
                                </a>
                                <!-- PROVINCIA -->
                                {% if request.user|has_group:"ProvinciaCeliaquia" %}
                                    {% if exp.estado.nombre == 'CREADO' %}
                                        <a href="{% url 'expediente_update' exp.pk %}"
                                           class="btn btn-editar"
                                           title="Editar expediente">
                                            <i class="fas fa-edit"></i>
                                            Editar
                                        </a>
                                        <button type="button"
                                                class="btn btn-secondary js-process"
                                                data-process-url="{% url 'expediente_procesar' exp.pk %}"
                                                title="Procesar expediente">
                                            <i class="fas fa-cog"></i>
                                            Procesar
                                        </button>
                                    {% elif exp.estado.nombre == 'EN_ESPERA' %}
                                        <button type="button"
                                                class="btn btn-secondary js-confirm"
                                                data-confirm-url="{% url 'expediente_confirm' exp.pk %}"
                                                title="Confirmar envío">
                                            <i class="fas fa-check-circle"></i>
                                            Confirmar Envío
                                        </button>
                                    {% endif %}
                                {% endif %}
                                <!-- SUBSECRETARÍA -->
                                {% if request.user|has_group:"CoordinadorCeliaquia" %}
                                    {% if exp.estado.nombre == 'CONFIRMACION_DE_ENVIO' %}
                                        <button type="button"
                                                class="btn btn-secondary js-recepcionar"
                                                data-recepcionar-url="{% url 'expediente_recepcionar' exp.pk %}"
                                                title="Recepcionar expediente">
                                            <i class="fas fa-inbox"></i>
                                            Recepcionar
                                        </button>
                                    {% endif %}
                                    <!-- Mostrar Asignar solo si RECEPCIONADO o ASIGNADO -->
                                    {% if exp.estado.nombre == 'RECEPCIONADO' or exp.estado.nombre == 'ASIGNADO' %}
                                        <button type="button"
                                                class="btn btn-secondary js-assign"
                                                data-assign-url="{% url 'expediente_asignar_tecnico' exp.pk %}"
                                                title="Asignar técnico">
                                            <i class="fas fa-user-plus"></i>
                                            Asignar
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="{% if request.user|has_group:'CoordinadorCeliaquia' or request.user|has_group:'TecnicoCeliaquia' %}7{% else %}6{% endif %}"
                                class="text-center text-muted py-3">No hay expedientes registrados.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if is_paginated %}
            <div class="card-footer">
                <nav>
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">« Anterior</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">« Anterior</span>
                            </li>
                        {% endif %}
                        {% for i in page_obj.paginator.page_range %}
                            {% if page_obj.number == i %}
                                <li class="page-item active">
                                    <span class="page-link">{{ i }}</span>
                                </li>
                            {% elif i >= page_obj.number|add:"-2" and i <= page_obj.number|add:"2" %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente »</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Siguiente »</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        {% endif %}
    </div>
{% endblock %}
{% block customJS %}
    <script>window.CSRF_TOKEN = "{{ csrf_token }}";</script>
    <script src="{% static 'custom/js/celiaquia_list.js' %}"></script>
    <!-- Script de ordenamiento reutilizable para tablas -->
    <script src="{% static 'custom/js/listSort.js' %}"></script>
{% endblock %}
