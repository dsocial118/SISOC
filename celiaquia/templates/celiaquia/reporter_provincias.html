{% extends "includes/main.html" %}
{% load static %}

{% block title %}Reporter de Provincias - Celiaquia{% endblock %}

{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item">
            <a href="{% url 'reporter_provincias' %}">Reporter</a>
        </li>
        <li class="breadcrumb-item active">Provincias</li>
    </ol>
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'custom/css/reporter_provincias.css' %}">
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<h2 class="h3 mb-4">üìä Reporter de Provincias</h2>

<!-- Filtros -->
<div class="filter-section">
    <form method="get" class="filter-form">
        <div class="filter-row">
            <div class="filter-group">
                <label for="provincia">Provincia</label>
                <select name="provincia" id="provincia">
                    <option value="">Todas las provincias</option>
                    {% for provincia in provincias %}
                        <option value="{{ provincia.id }}" {% if provincia.id|stringformat:"s" == provincia_seleccionada %}selected{% endif %}>
                            {{ provincia.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="fecha_desde">Desde</label>
                <input type="date" name="fecha_desde" id="fecha_desde" value="{{ fecha_desde }}">
            </div>
            
            <div class="filter-group">
                <label for="fecha_hasta">Hasta</label>
                <input type="date" name="fecha_hasta" id="fecha_hasta" value="{{ fecha_hasta }}">
            </div>
            
            <div class="filter-group">
                <label for="estado">Estado</label>
                <select name="estado" id="estado">
                    <option value="">Todos los estados</option>
                    <option value="PENDIENTE" {% if estado_filtro == "PENDIENTE" %}selected{% endif %}>Pendiente</option>
                    <option value="APROBADO" {% if estado_filtro == "APROBADO" %}selected{% endif %}>Aprobado</option>
                    <option value="RECHAZADO" {% if estado_filtro == "RECHAZADO" %}selected{% endif %}>Rechazado</option>
                </select>
            </div>
        </div>
        
        <div class="filter-row">
            <div style="display: flex; gap: 1rem; justify-content: flex-end; grid-column: 1 / -1;">
                <button type="submit" class="btn-filter">üîç Filtrar</button>
                <a href="{% url 'reporter_provincias' %}" class="btn-reset">‚Üª Limpiar</a>
            </div>
        </div>
    </form>
</div>

<!-- Estad√≠sticas Generales -->
<div class="stats-grid">
    <div class="stat-card info">
        <div class="stat-label">Total de Casos</div>
        <div class="stat-number">{{ total_casos }}</div>
        <div class="stat-percentage">Registros procesados</div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-label">Documentos Completos</div>
        <div class="stat-number">{{ casos_documentos_ok }}</div>
        <div class="stat-percentage" data-total="{{ total_casos }}" data-value="{{ casos_documentos_ok }}"></div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-label">Documentos Incompletos</div>
        <div class="stat-number">{{ casos_documentos_incompletos }}</div>
        <div class="stat-percentage" data-total="{{ total_casos }}" data-value="{{ casos_documentos_incompletos }}"></div>
    </div>
    
    <div class="stat-card info">
        <div class="stat-label">Con Comentarios</div>
        <div class="stat-number">{{ casos_con_comentarios }}</div>
        <div class="stat-percentage">Casos con observaciones</div>
    </div>
</div>

<!-- Instancias de Validaci√≥n -->
<div class="instancia-section">
    <div class="instancia-title">üîç Validaci√≥n T√©cnica</div>
    <div class="instancia-grid">
        <div class="instancia-item">
            <div class="instancia-label">Pendiente</div>
            <div class="instancia-count">{{ casos_por_instancia.validacion_tecnica.pendiente }}</div>
        </div>
        <div class="instancia-item success">
            <div class="instancia-label">Aprobado</div>
            <div class="instancia-count">{{ casos_por_instancia.validacion_tecnica.aprobado }}</div>
        </div>
        <div class="instancia-item danger">
            <div class="instancia-label">Rechazado</div>
            <div class="instancia-count">{{ casos_por_instancia.validacion_tecnica.rechazado }}</div>
        </div>
        <div class="instancia-item warning">
            <div class="instancia-label">Subsanar</div>
            <div class="instancia-count">{{ casos_por_instancia.validacion_tecnica.subsanar }}</div>
        </div>
        <div class="instancia-item success">
            <div class="instancia-label">Subsanado</div>
            <div class="instancia-count">{{ casos_por_instancia.validacion_tecnica.subsanado }}</div>
        </div>
    </div>
</div>

<div class="instancia-section">
    <div class="instancia-title">üîó Cruce SINTYS</div>
    <div class="instancia-grid">
        <div class="instancia-item">
            <div class="instancia-label">Sin Cruce</div>
            <div class="instancia-count">{{ casos_por_instancia.sintys.sin_cruce }}</div>
        </div>
        <div class="instancia-item success">
            <div class="instancia-label">Match</div>
            <div class="instancia-count">{{ casos_por_instancia.sintys.match }}</div>
        </div>
        <div class="instancia-item danger">
            <div class="instancia-label">No Match</div>
            <div class="instancia-count">{{ casos_por_instancia.sintys.no_match }}</div>
        </div>
    </div>
</div>

<div class="instancia-section">
    <div class="instancia-title">üí∞ Estado de Cupo</div>
    <div class="instancia-grid">
        <div class="instancia-item">
            <div class="instancia-label">No Evaluado</div>
            <div class="instancia-count">{{ casos_por_instancia.cupo.no_eval }}</div>
        </div>
        <div class="instancia-item success">
            <div class="instancia-label">Dentro de Cupo</div>
            <div class="instancia-count">{{ casos_por_instancia.cupo.dentro }}</div>
        </div>
        <div class="instancia-item danger">
            <div class="instancia-label">Fuera de Cupo</div>
            <div class="instancia-count">{{ casos_por_instancia.cupo.fuera }}</div>
        </div>
    </div>
</div>

<!-- Gr√°ficos -->
<div class="charts-grid">
    <div class="chart-container">
        <div class="chart-title">üìà Validaci√≥n T√©cnica</div>
        <canvas id="chartValidacion"></canvas>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">üîó Resultados SINTYS</div>
        <canvas id="chartSintys"></canvas>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">üí∞ Estado de Cupo</div>
        <canvas id="chartCupo"></canvas>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">üìç Casos por Provincia</div>
        <canvas id="chartProvincias"></canvas>
    </div>
</div>

<!-- Tabla de Detalle -->
<div class="table-container">
    <div class="table-title">üìã √öltimos Casos Procesados</div>
    <table>
        <thead>
            <tr>
                <th>Documento</th>
                <th>Nombre</th>
                <th>Provincia</th>
                <th>Validaci√≥n T√©cnica</th>
                <th>SINTYS</th>
                <th>Cupo</th>
                <th>Documentos</th>
                <th>Fecha</th>
            </tr>
        </thead>
        <tbody>
            {% for caso in ultimos_casos %}
            <tr>
                <td>{{ caso.ciudadano.documento }}</td>
                <td>{{ caso.ciudadano.nombre }} {{ caso.ciudadano.apellido }}</td>
                <td>{{ caso.expediente.provincia.nombre }}</td>
                <td>
                    <span class="badge {% if caso.revision_tecnico == 'APROBADO' %}badge-success{% elif caso.revision_tecnico == 'RECHAZADO' %}badge-danger{% elif caso.revision_tecnico == 'SUBSANAR' %}badge-warning{% else %}badge-secondary{% endif %}">
                        {{ caso.get_revision_tecnico_display }}
                    </span>
                </td>
                <td>
                    <span class="badge {% if caso.resultado_sintys == 'MATCH' %}badge-success{% elif caso.resultado_sintys == 'NO_MATCH' %}badge-danger{% else %}badge-secondary{% endif %}">
                        {{ caso.get_resultado_sintys_display }}
                    </span>
                </td>
                <td>
                    <span class="badge {% if caso.estado_cupo == 'DENTRO' %}badge-success{% elif caso.estado_cupo == 'FUERA' %}badge-danger{% else %}badge-secondary{% endif %}">
                        {{ caso.get_estado_cupo_display }}
                    </span>
                </td>
                <td>
                    {% if caso.archivos_ok %}
                        <span class="badge badge-success">‚úì Completo</span>
                    {% else %}
                        <span class="badge badge-warning">‚ö† Incompleto</span>
                    {% endif %}
                </td>
                <td>{{ caso.creado_en|date:"d/m/Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center; color: #9ca3af;">No hay casos para mostrar</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block customJS %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
    document.querySelectorAll('.stat-percentage[data-total]').forEach(el => {
        const total = parseInt(el.dataset.total);
        const value = parseInt(el.dataset.value);
        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
        el.textContent = percentage + '%';
    });
    
    const colors = {
        primary: '#667eea',
        success: '#10b981',
        warning: '#f59e0b',
        danger: '#ef4444',
        info: '#3b82f6',
        secondary: '#6b7280'
    };
    
    const ctxValidacion = document.getElementById('chartValidacion').getContext('2d');
    new Chart(ctxValidacion, {
        type: 'doughnut',
        data: {
            labels: ['Pendiente', 'Aprobado', 'Rechazado', 'Subsanar', 'Subsanado'],
            datasets: [{
                data: [
                    {{ casos_por_instancia.validacion_tecnica.pendiente }},
                    {{ casos_por_instancia.validacion_tecnica.aprobado }},
                    {{ casos_por_instancia.validacion_tecnica.rechazado }},
                    {{ casos_por_instancia.validacion_tecnica.subsanar }},
                    {{ casos_por_instancia.validacion_tecnica.subsanado }}
                ],
                backgroundColor: [
                    colors.secondary,
                    colors.success,
                    colors.danger,
                    colors.warning,
                    colors.info
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                }
            }
        }
    });
    
    const ctxSintys = document.getElementById('chartSintys').getContext('2d');
    new Chart(ctxSintys, {
        type: 'bar',
        data: {
            labels: ['Sin Cruce', 'Match', 'No Match'],
            datasets: [{
                label: 'Cantidad',
                data: [
                    {{ casos_por_instancia.sintys.sin_cruce }},
                    {{ casos_por_instancia.sintys.match }},
                    {{ casos_por_instancia.sintys.no_match }}
                ],
                backgroundColor: [colors.secondary, colors.success, colors.danger],
                borderRadius: 6,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
    
    const ctxCupo = document.getElementById('chartCupo').getContext('2d');
    new Chart(ctxCupo, {
        type: 'pie',
        data: {
            labels: ['No Evaluado', 'Dentro de Cupo', 'Fuera de Cupo'],
            datasets: [{
                data: [
                    {{ casos_por_instancia.cupo.no_eval }},
                    {{ casos_por_instancia.cupo.dentro }},
                    {{ casos_por_instancia.cupo.fuera }}
                ],
                backgroundColor: [colors.secondary, colors.success, colors.danger],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                }
            }
        }
    });
    
    const ctxProvincias = document.getElementById('chartProvincias').getContext('2d');
    const provinciasData = {{ expedientes_por_provincia|safe }} || [];
    const provinciasLabels = provinciasData.length > 0 ? provinciasData.map(p => p.usuario_provincia__profile__provincia__nombre) : [];
    const provinciasValues = provinciasData.length > 0 ? provinciasData.map(p => p.casos) : [];
    
    if (provinciasLabels.length > 0) {
        new Chart(ctxProvincias, {
            type: 'bar',
            data: {
                labels: provinciasLabels,
                datasets: [{
                    label: 'Casos',
                    data: provinciasValues,
                    backgroundColor: colors.primary,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }
</script>
{% endblock %}
